import test from '@interactjs/_dev/test/test';
import interactions from '@interactjs/core/interactions';
import { ActionName } from '@interactjs/core/scope';
import * as helpers from '@interactjs/core/tests/helpers';
import { extend } from '@interactjs/utils';
import pointerUtils from '@interactjs/utils/pointerUtils';
import drag from '../drag';
test('drag action init', (t) => {
    const scope = helpers.mockScope();
    drag.install(scope);
    t.ok(scope.actions.names.includes(ActionName.Drag), '"drag" in actions.names');
    t.equal(scope.actions.methodDict.drag, 'draggable');
    t.equal(typeof scope.Interactable.prototype.draggable, 'function');
    t.end();
});
test('Interactable.draggable method', (t) => {
    const interactable = {
        options: {
            drag: {},
        },
        draggable: drag.draggable,
        setPerAction: () => { calledSetPerAction = true; },
        setOnEvents: () => { calledSetOnEvents = true; },
    };
    let calledSetPerAction = false;
    let calledSetOnEvents = false;
    t.equal(interactable.draggable(), interactable.options.drag, 'interactable.draggable() returns interactable.options.drag object');
    interactable.draggable(true);
    t.ok(interactable.options.drag.enabled, 'calling `interactable.draggable(true)` enables dragging');
    interactable.draggable(false);
    t.notOk(interactable.options.drag.enabled, 'calling `interactable.draggable(false)` disables dragging');
    interactable.draggable({});
    t.ok(interactable.options.drag.enabled, 'calling `interactable.draggable({})` enables dragging');
    t.ok(calledSetOnEvents, 'calling `interactable.draggable({})` calls this.setOnEvents');
    t.ok(calledSetPerAction, 'calling `interactable.draggable({})` calls this.setPerAction');
    interactable.draggable({ enabled: false });
    t.notOk(interactable.options.drag.enabled, 'calling `interactable.draggable({ enabled: false })` disables dragging');
    const axisSettings = {
        lockAxis: ['x', 'y', 'xy', 'start'],
        startAxis: ['x', 'y', 'xy'],
    };
    for (const axis in axisSettings) {
        for (const value of axisSettings[axis]) {
            const options = {};
            options[axis] = value;
            interactable.draggable(options);
            t.equal(interactable.options.drag[axis], value, '`' + axis + ': "' + value + '"` is set correctly');
            delete interactable.options.drag[axis];
        }
    }
    t.end();
});
test('drag axis', (t) => {
    const scope = helpers.mockScope();
    interactions.install(scope);
    drag.install(scope);
    const interaction = scope.interactions.new({});
    const element = {};
    const interactable = {
        options: {
            drag: {},
        },
        target: element,
    };
    const iEvent = { page: {}, client: {}, delta: {}, type: 'dragmove' };
    const opposites = { x: 'y', y: 'x' };
    const eventCoords = {
        page: { x: -1, y: -2 },
        client: { x: -3, y: -4 },
        delta: { x: -5, y: -6 },
    };
    const coords = helpers.newCoordsSet();
    resetCoords();
    interaction.prepared = { name: 'drag', axis: 'xy' };
    interaction.target = interactable;
    t.test('xy (any direction)', (tt) => {
        scope.interactions.signals.fire('before-action-move', { interaction });
        tt.deepEqual(interaction.coords.start, coords.start, 'coords.start is not modified');
        tt.deepEqual(interaction.coords.delta, coords.delta, 'coords.delta is not modified');
        scope.interactions.signals.fire('action-move', { iEvent, interaction });
        tt.deepEqual(iEvent.page, eventCoords.page, 'page coords are not modified');
        tt.deepEqual(iEvent.delta, eventCoords.delta, 'delta is not modified');
        tt.end();
    });
    for (const axis in opposites) {
        const opposite = opposites[axis];
        t.test(axis + '-axis', (tt) => {
            resetCoords();
            interaction.prepared.axis = axis;
            scope.interactions.signals.fire('action-move', { iEvent, interaction });
            tt.deepEqual(iEvent.delta, {
                [opposite]: 0,
                [axis]: eventCoords.delta[axis],
            }, `opposite axis (${opposite}) delta is 0; target axis (${axis}) delta is not modified`);
            tt.deepEqual(iEvent.page, {
                [opposite]: coords.start.page[opposite],
                [axis]: eventCoords.page[axis],
            }, `page.${opposite} is coords.start value`);
            tt.equal(iEvent.page[axis], eventCoords.page[axis], `page.${axis} is not modified`);
            tt.equal(iEvent.client[opposite], coords.start.client[opposite], `client.${opposite} is coords.start value`);
            tt.equal(iEvent.client[axis], eventCoords.client[axis], `client.${axis} is not modified`);
            tt.end();
        });
    }
    t.end();
    function resetCoords() {
        pointerUtils.copyCoords(iEvent, eventCoords);
        extend(iEvent.delta, eventCoords.delta);
        for (const prop in coords) {
            pointerUtils.copyCoords(interaction.coords[prop], coords[prop]);
        }
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHJhZy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImRyYWcudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxJQUFJLE1BQU0sNEJBQTRCLENBQUE7QUFDN0MsT0FBTyxZQUFZLE1BQU0sK0JBQStCLENBQUE7QUFDeEQsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLHdCQUF3QixDQUFBO0FBQ25ELE9BQU8sS0FBSyxPQUFPLE1BQU0sZ0NBQWdDLENBQUE7QUFDekQsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLG1CQUFtQixDQUFBO0FBQzFDLE9BQU8sWUFBWSxNQUFNLGdDQUFnQyxDQUFBO0FBQ3pELE9BQU8sSUFBSSxNQUFNLFNBQVMsQ0FBQTtBQUUxQixJQUFJLENBQUMsa0JBQWtCLEVBQUUsQ0FBQyxDQUFDLEVBQUUsRUFBRTtJQUM3QixNQUFNLEtBQUssR0FBRyxPQUFPLENBQUMsU0FBUyxFQUFFLENBQUE7SUFFakMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQTtJQUVuQixDQUFDLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLEVBQUUseUJBQXlCLENBQUMsQ0FBQTtJQUM5RSxDQUFDLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLElBQUksRUFBRSxXQUFXLENBQUMsQ0FBQTtJQUNuRCxDQUFDLENBQUMsS0FBSyxDQUFDLE9BQU8sS0FBSyxDQUFDLFlBQVksQ0FBQyxTQUFTLENBQUMsU0FBUyxFQUFFLFVBQVUsQ0FBQyxDQUFBO0lBRWxFLENBQUMsQ0FBQyxHQUFHLEVBQUUsQ0FBQTtBQUNULENBQUMsQ0FBQyxDQUFBO0FBRUYsSUFBSSxDQUFDLCtCQUErQixFQUFFLENBQUMsQ0FBQyxFQUFFLEVBQUU7SUFDMUMsTUFBTSxZQUFZLEdBQUc7UUFDbkIsT0FBTyxFQUFFO1lBQ1AsSUFBSSxF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TUFBTSxFQUFFO1lBQ3pCLFlBQVksQ0FBQyxVQUFVLENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBRSxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQTtTQUNoRTtJQUNILENBQUM7QUFDSCxDQUFDLENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB0ZXN0IGZyb20gJ0BpbnRlcmFjdGpzL19kZXYvdGVzdC90ZXN0J1xuaW1wb3J0IGludGVyYWN0aW9ucyBmcm9tICdAaW50ZXJhY3Rqcy9jb3JlL2ludGVyYWN0aW9ucydcbmltcG9ydCB7IEFjdGlvbk5hbWUgfSBmcm9tICdAaW50ZXJhY3Rqcy9jb3JlL3Njb3BlJ1xuaW1wb3J0ICogYXMgaGVscGVycyBmcm9tICdAaW50ZXJhY3Rqcy9jb3JlL3Rlc3RzL2hlbHBlcnMnXG5pbXBvcnQgeyBleHRlbmQgfSBmcm9tICdAaW50ZXJhY3Rqcy91dGlscydcbmltcG9ydCBwb2ludGVyVXRpbHMgZnJvbSAnQGludGVyYWN0anMvdXRpbHMvcG9pbnRlclV0aWxzJ1xuaW1wb3J0IGRyYWcgZnJvbSAnLi4vZHJhZydcblxudGVzdCgnZHJhZyBhY3Rpb24gaW5pdCcsICh0KSA9PiB7XG4gIGNvbnN0IHNjb3BlID0gaGVscGVycy5tb2NrU2NvcGUoKVxuXG4gIGRyYWcuaW5zdGFsbChzY29wZSlcblxuICB0Lm9rKHNjb3BlLmFjdGlvbnMubmFtZXMuaW5jbHVkZXMoQWN0aW9uTmFtZS5EcmFnKSwgJ1wiZHJhZ1wiIGluIGFjdGlvbnMubmFtZXMnKVxuICB0LmVxdWFsKHNjb3BlLmFjdGlvbnMubWV0aG9kRGljdC5kcmFnLCAnZHJhZ2dhYmxlJylcbiAgdC5lcXVhbCh0eXBlb2Ygc2NvcGUuSW50ZXJhY3RhYmxlLnByb3RvdHlwZS5kcmFnZ2FibGUsICdmdW5jdGlvbicpXG5cbiAgdC5lbmQoKVxufSlcblxudGVzdCgnSW50ZXJhY3RhYmxlLmRyYWdnYWJsZSBtZXRob2QnLCAodCkgPT4ge1xuICBjb25zdCBpbnRlcmFjdGFibGUgPSB7XG4gICAgb3B0aW9uczoge1xuICAgICAgZHJhZzoge30sXG4gICAgfSxcbiAgICBkcmFnZ2FibGU6IGRyYWcuZHJhZ2dhYmxlLFxuICAgIHNldFBlckFjdGlvbjogKCkgPT4geyBjYWxsZWRTZXRQZXJBY3Rpb24gPSB0cnVlIH0sXG4gICAgc2V0T25FdmVudHM6ICgpID0+IHsgY2FsbGVkU2V0T25FdmVudHMgPSB0cnVlIH0sXG4gIH0gYXMgdW5rbm93biBhcyBJbnRlcmFjdC5JbnRlcmFjdGFibGVcbiAgbGV0IGNhbGxlZFNldFBlckFjdGlvbiA9IGZhbHNlXG4gIGxldCBjYWxsZWRTZXRPbkV2ZW50cyA9IGZhbHNlXG5cbiAgdC5lcXVhbChpbnRlcmFjdGFibGUuZHJhZ2dhYmxlKCksIGludGVyYWN0YWJsZS5vcHRpb25zLmRyYWcsXG4gICAgJ2ludGVyYWN0YWJsZS5kcmFnZ2FibGUoKSByZXR1cm5zIGludGVyYWN0YWJsZS5vcHRpb25zLmRyYWcgb2JqZWN0JylcblxuICBpbnRlcmFjdGFibGUuZHJhZ2dhYmxlKHRydWUpXG4gIHQub2soaW50ZXJhY3RhYmxlLm9wdGlvbnMuZHJhZy5lbmFibGVkLFxuICAgICdjYWxsaW5nIGBpbnRlcmFjdGFibGUuZHJhZ2dhYmxlKHRydWUpYCBlbmFibGVzIGRyYWdnaW5nJylcblxuICBpbnRlcmFjdGFibGUuZHJhZ2dhYmxlKGZhbHNlKVxuICB0Lm5vdE9rKGludGVyYWN0YWJsZS5vcHRpb25zLmRyYWcuZW5hYmxlZCxcbiAgICAnY2FsbGluZyBgaW50ZXJhY3RhYmxlLmRyYWdnYWJsZShmYWxzZSlgIGRpc2FibGVzIGRyYWdnaW5nJylcblxuICBpbnRlcmFjdGFibGUuZHJhZ2dhYmxlKHt9KVxuICB0Lm9rKGludGVyYWN0YWJsZS5vcHRpb25zLmRyYWcuZW5hYmxlZCxcbiAgICAnY2FsbGluZyBgaW50ZXJhY3RhYmxlLmRyYWdnYWJsZSh7fSlgIGVuYWJsZXMgZHJhZ2dpbmcnKVxuICB0Lm9rKGNhbGxlZFNldE9uRXZlbnRzLFxuICAgICdjYWxsaW5nIGBpbnRlcmFjdGFibGUuZHJhZ2dhYmxlKHt9KWAgY2FsbHMgdGhpcy5zZXRPbkV2ZW50cycpXG4gIHQub2soY2FsbGVkU2V0UGVyQWN0aW9uLFxuICAgICdjYWxsaW5nIGBpbnRlcmFjdGFibGUuZHJhZ2dhYmxlKHt9KWAgY2FsbHMgdGhpcy5zZXRQZXJBY3Rpb24nKVxuXG4gIGludGVyYWN0YWJsZS5kcmFnZ2FibGUoeyBlbmFibGVkOiBmYWxzZSB9KVxuICB0Lm5vdE9rKGludGVyYWN0YWJsZS5vcHRpb25zLmRyYWcuZW5hYmxlZCxcbiAgICAnY2FsbGluZyBgaW50ZXJhY3RhYmxlLmRyYWdnYWJsZSh7IGVuYWJsZWQ6IGZhbHNlIH0pYCBkaXNhYmxlcyBkcmFnZ2luZycpXG5cbiAgY29uc3QgYXhpc1NldHRpbmdzID0ge1xuICAgIGxvY2tBeGlzOiBbJ3gnLCAneScsICd4eScsICdzdGFydCddLFxuICAgIHN0YXJ0QXhpczogWyd4JywgJ3knLCAneHknXSxcbiAgfVxuXG4gIGZvciAoY29uc3QgYXhpcyBpbiBheGlzU2V0dGluZ3MpIHtcbiAgICBmb3IgKGNvbnN0IHZhbHVlIG9mIGF4aXNTZXR0aW5nc1theGlzXSkge1xuICAgICAgY29uc3Qgb3B0aW9ucyA9IHt9XG5cbiAgICAgIG9wdGlvbnNbYXhpc10gPSB2YWx1ZVxuXG4gICAgICBpbnRlcmFjdGFibGUuZHJhZ2dhYmxlKG9wdGlvbnMpXG4gICAgICB0LmVxdWFsKGludGVyYWN0YWJsZS5vcHRpb25zLmRyYWdbYXhpc10sIHZhbHVlLFxuICAgICAgICAnYCcgKyBheGlzICsgJzogXCInICsgdmFsdWUgKyAnXCJgIGlzIHNldCBjb3JyZWN0bHknKVxuXG4gICAgICBkZWxldGUgaW50ZXJhY3RhYmxlLm9wdGlvbnMuZHJhZ1theGlzXVxuICAgIH1cbiAgfVxuXG4gIHQuZW5kKClcbn0pXG5cbnRlc3QoJ2RyYWcgYXhpcycsICh0KSA9PiB7XG4gIGNvbnN0IHNjb3BlID0gaGVscGVycy5tb2NrU2NvcGUoKVxuXG4gIGludGVyYWN0aW9ucy5pbnN0YWxsKHNjb3BlKVxuICBkcmFnLmluc3RhbGwoc2NvcGUpXG5cbiAgY29uc3QgaW50ZXJhY3Rpb24gPSBzY29wZS5pbnRlcmFjdGlvbnMubmV3KHt9KVxuICBjb25zdCBlbGVtZW50ID0ge31cbiAgY29uc3QgaW50ZXJhY3RhYmxlID0ge1xuICAgIG9wdGlvbnM6IHtcbiAgICAgIGRyYWc6IHt9LFxuICAgIH0sXG4gICAgdGFyZ2V0OiBlbGVtZW50LFxuICB9IGFzIEludGVyYWN0LkludGVyYWN0YWJsZVxuICBjb25zdCBpRXZlbnQgPSB7IHBhZ2U6IHt9LCBjbGllbnQ6IHt9LCBkZWx0YToge30sIHR5cGU6ICdkcmFnbW92ZScgfSBhcyBJbnRlcmFjdC5JbnRlcmFjdEV2ZW50XG5cbiAgY29uc3Qgb3Bwb3NpdGVzID0geyB4OiAneScsIHk6ICd4JyB9XG4gIGNvbnN0IGV2ZW50Q29vcmRzID0ge1xuICAgIHBhZ2U6IHsgeDogLTEsIHk6IC0yIH0sXG4gICAgY2xpZW50OiB7IHg6IC0zLCB5OiAtNCB9LFxuICAgIGRlbHRhOiB7IHg6IC01LCB5OiAtNiB9LFxuICB9XG4gIGNvbnN0IGNvb3JkcyA9IGhlbHBlcnMubmV3Q29vcmRzU2V0KClcblxuICByZXNldENvb3JkcygpXG4gIGludGVyYWN0aW9uLnByZXBhcmVkID0geyBuYW1lOiAnZHJhZycsIGF4aXM6ICd4eScgfVxuICBpbnRlcmFjdGlvbi50YXJnZXQgPSBpbnRlcmFjdGFibGVcblxuICB0LnRlc3QoJ3h5IChhbnkgZGlyZWN0aW9uKScsICh0dCkgPT4ge1xuICAgIHNjb3BlLmludGVyYWN0aW9ucy5zaWduYWxzLmZpcmUoJ2JlZm9yZS1hY3Rpb24tbW92ZScsIHsgaW50ZXJhY3Rpb24gfSlcblxuICAgIHR0LmRlZXBFcXVhbChpbnRlcmFjdGlvbi5jb29yZHMuc3RhcnQsIGNvb3Jkcy5zdGFydCxcbiAgICAgICdjb29yZHMuc3RhcnQgaXMgbm90IG1vZGlmaWVkJylcbiAgICB0dC5kZWVwRXF1YWwoaW50ZXJhY3Rpb24uY29vcmRzLmRlbHRhLCBjb29yZHMuZGVsdGEsXG4gICAgICAnY29vcmRzLmRlbHRhIGlzIG5vdCBtb2RpZmllZCcpXG5cbiAgICBzY29wZS5pbnRlcmFjdGlvbnMuc2lnbmFscy5maXJlKCdhY3Rpb24tbW92ZScsIHsgaUV2ZW50LCBpbnRlcmFjdGlvbiB9KVxuXG4gICAgdHQuZGVlcEVxdWFsKGlFdmVudC5wYWdlLCBldmVudENvb3Jkcy5wYWdlLCAncGFnZSBjb29yZHMgYXJlIG5vdCBtb2RpZmllZCcpXG4gICAgdHQuZGVlcEVxdWFsKGlFdmVudC5kZWx0YSwgZXZlbnRDb29yZHMuZGVsdGEsICdkZWx0YSBpcyBub3QgbW9kaWZpZWQnKVxuXG4gICAgdHQuZW5kKClcbiAgfSlcblxuICBmb3IgKGNvbnN0IGF4aXMgaW4gb3Bwb3NpdGVzKSB7XG4gICAgY29uc3Qgb3Bwb3NpdGUgPSBvcHBvc2l0ZXNbYXhpc11cblxuICAgIHQudGVzdChheGlzICsgJy1heGlzJywgKHR0KSA9PiB7XG4gICAgICByZXNldENvb3JkcygpXG4gICAgICBpbnRlcmFjdGlvbi5wcmVwYXJlZC5heGlzID0gYXhpcyBhcyBhbnlcblxuICAgICAgc2NvcGUuaW50ZXJhY3Rpb25zLnNpZ25hbHMuZmlyZSgnYWN0aW9uLW1vdmUnLCB7IGlFdmVudCwgaW50ZXJhY3Rpb24gfSlcblxuICAgICAgdHQuZGVlcEVxdWFsKFxuICAgICAgICBpRXZlbnQuZGVsdGEsXG4gICAgICAgIHtcbiAgICAgICAgICBbb3Bwb3NpdGVdOiAwLFxuICAgICAgICAgIFtheGlzXTogZXZlbnRDb29yZHMuZGVsdGFbYXhpc10sXG4gICAgICAgIH0sXG4gICAgICAgIGBvcHBvc2l0ZSBheGlzICgke29wcG9zaXRlfSkgZGVsdGEgaXMgMDsgdGFyZ2V0IGF4aXMgKCR7YXhpc30pIGRlbHRhIGlzIG5vdCBtb2RpZmllZGApXG5cbiAgICAgIHR0LmRlZXBFcXVhbChcbiAgICAgICAgaUV2ZW50LnBhZ2UsXG4gICAgICAgIHtcbiAgICAgICAgICBbb3Bwb3NpdGVdOiBjb29yZHMuc3RhcnQucGFnZVtvcHBvc2l0ZV0sXG4gICAgICAgICAgW2F4aXNdOiBldmVudENvb3Jkcy5wYWdlW2F4aXNdLFxuICAgICAgICB9LFxuICAgICAgICBgcGFnZS4ke29wcG9zaXRlfSBpcyBjb29yZHMuc3RhcnQgdmFsdWVgXG4gICAgICApXG5cbiAgICAgIHR0LmVxdWFsKFxuICAgICAgICBpRXZlbnQucGFnZVtheGlzXSxcbiAgICAgICAgZXZlbnRDb29yZHMucGFnZVtheGlzXSxcbiAgICAgICAgYHBhZ2UuJHtheGlzfSBpcyBub3QgbW9kaWZpZWRgXG4gICAgICApXG5cbiAgICAgIHR0LmVxdWFsKFxuICAgICAgICBpRXZlbnQuY2xpZW50W29wcG9zaXRlXSxcbiAgICAgICAgY29vcmRzLnN0YXJ0LmNsaWVudFtvcHBvc2l0ZV0sXG4gICAgICAgIGBjbGllbnQuJHtvcHBvc2l0ZX0gaXMgY29vcmRzLnN0YXJ0IHZhbHVlYFxuICAgICAgKVxuICAgICAgdHQuZXF1YWwoXG4gICAgICAgIGlFdmVudC5jbGllbnRbYXhpc10sXG4gICAgICAgIGV2ZW50Q29vcmRzLmNsaWVudFtheGlzXSxcbiAgICAgICAgYGNsaWVudC4ke2F4aXN9IGlzIG5vdCBtb2RpZmllZGBcbiAgICAgIClcblxuICAgICAgdHQuZW5kKClcbiAgICB9KVxuICB9XG5cbiAgdC5lbmQoKVxuXG4gIGZ1bmN0aW9uIHJlc2V0Q29vcmRzICgpIHtcbiAgICBwb2ludGVyVXRpbHMuY29weUNvb3JkcyhpRXZlbnQsIGV2ZW50Q29vcmRzKVxuICAgIGV4dGVuZChpRXZlbnQuZGVsdGEsIGV2ZW50Q29vcmRzLmRlbHRhKVxuXG4gICAgZm9yIChjb25zdCBwcm9wIGluIGNvb3Jkcykge1xuICAgICAgcG9pbnRlclV0aWxzLmNvcHlDb29yZHMoaW50ZXJhY3Rpb24uY29vcmRzW3Byb3BdLCBjb29yZHNbcHJvcF0pXG4gICAgfVxuICB9XG59KVxuIl19