import * as arr from '@interactjs/utils/arr';
import * as domUtils from '@interactjs/utils/domUtils';
import extend from '@interactjs/utils/extend';
import * as is from '@interactjs/utils/is';
import Signals from '@interactjs/utils/Signals';
export default class InteractableSet {
    constructor(scope) {
        this.scope = scope;
        this.signals = new Signals();
        // all set interactables
        this.list = [];
        this.selectorMap = {};
        this.signals.on('unset', ({ interactable }) => {
            const { target, _context: context } = interactable;
            const targetMappings = is.string(target)
                ? this.selectorMap[target]
                : target[this.scope.id];
            const targetIndex = targetMappings.findIndex((m) => m.context === context);
            if (targetMappings[targetIndex]) {
                // Destroying mappingInfo's context and interactable
                targetMappings[targetIndex].context = null;
                targetMappings[targetIndex].interactable = null;
            }
            targetMappings.splice(targetIndex, 1);
        });
    }
    new(target, options) {
        options = extend(options || {}, {
            actions: this.scope.actions,
        });
        const interactable = new this.scope.Interactable(target, options, this.scope.document);
        const mappingInfo = { context: interactable._context, interactable };
        this.scope.addDocument(interactable._doc);
        this.list.push(interactable);
        if (is.string(target)) {
            if (!this.selectorMap[target]) {
                this.selectorMap[target] = [];
            }
            this.selectorMap[target].push(mappingInfo);
        }
        else {
            if (!interactable.target[this.scope.id]) {
                Object.defineProperty(target, this.scope.id, {
                    value: [],
                    configurable: true,
                });
            }
            target[this.scope.id].push(mappingInfo);
        }
        this.signals.fire('new', {
            target,
            options,
            interactable,
            win: this.scope._win,
        });
        return interactable;
    }
    get(target, options) {
        const context = (options && options.context) || this.scope.document;
        const isSelector = is.string(target);
        const targetMappings = isSelector
            ? this.selectorMap[target]
            : target[this.scope.id];
        if (!targetMappings) {
            return null;
        }
        const found = arr.find(targetMappings, (m) => m.context === context &&
            (isSelector || m.interactable.inContext(target)));
        return found && found.interactable;
    }
    forEachMatch(node, callback) {
        for (const interactable of this.list) {
            let ret;
            if ((is.string(interactable.target)
                // target is a selector and the element matches
                ? (is.element(node) && domUtils.matchesSelector(node, interactable.target))
                // target is the element
                : node === interactable.target) &&
                // the element is in context
                (interactable.inContext(node))) {
                ret = callback(interactable);
            }
            if (ret !== undefined) {
                return ret;
            }
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiSW50ZXJhY3RhYmxlU2V0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiSW50ZXJhY3RhYmxlU2V0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sS0FBSyxHQUFHLE1BQU0sdUJBQXVCLENBQUE7QUFDNUMsT0FBTyxLQUFLLFFBQVEsTUFBTSw0QkFBNEIsQ0FBQTtBQUN0RCxPQUFPLE1BQU0sTUFBTSwwQkFBMEIsQ0FBQTtBQUM3QyxPQUFPLEtBQUssRUFBRSxNQUFNLHNCQUFzQixDQUFBO0FBQzFDLE9BQU8sT0FBTyxNQUFNLDJCQUEyQixDQUFBO0FBRS9DLE1BQU0sQ0FBQyxPQUFPLE9BQU8sZUFBZTtJQVVsQyxZQUF1QixLQUFxQjtRQUFyQixVQUFLLEdBQUwsS0FBSyxDQUFnQjtRQVQ1QyxZQUFPLEdBQUcsSUFBSSxPQUFPLEVBQUUsQ0FBQTtRQUV2Qix3QkFBd0I7UUFDeEIsU0FBSSxHQUE0QixFQUFFLENBQUE7UUFFbEMsZ0JBQVcsR0FFUCxFQUFFLENBQUE7UUFHSixJQUFJLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxFQUFFLFlBQVksRUFBRSxFQUFFLEVBQUU7WUFDNUMsTUFBTSxFQUFFLE1BQU0sRUFBRSxRQUFRLEVBQUUsT0FBTyxFQUFFLEdBQUcsWUFBWSxDQUFBO1lBQ2xELE1BQU0sY0FBYyxHQUFHLEVBQUUsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDO2dCQUN0QyxDQUFDLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUM7Z0JBQzFCLENBQUMsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsQ0FBQTtZQUV6QixNQUFNLFdBQVcsR0FBRyxjQUFjLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsT0FBTyxLQUFLLE9BQU8sQ0FBQyxDQUFBO1lBQzFFLElBQUksY0FBYyxDQUFDLFdBQVcsQ0FBQyxF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QUMsQ0FBQyxZQUFZLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQTtRQUVyRCxPQUFPLEtBQUssSUFBSSxLQUFLLENBQUMsWUFBWSxDQUFBO0lBQ3BDLENBQUM7SUFFRCxZQUFZLENBQUUsSUFBd0IsRUFBRSxRQUFvQztRQUMxRSxLQUFLLE1BQU0sWUFBWSxJQUFJLElBQUksQ0FBQyxJQUFJLEVBQUU7WUFDcEMsSUFBSSxHQUFHLENBQUE7WUFFUCxJQUFJLENBQUMsRUFBRSxDQUFDLE1BQU0sQ0FBQyxZQUFZLENBQUMsTUFBTSxDQUFDO2dCQUNuQywrQ0FBK0M7Z0JBQzdDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLElBQUksUUFBUSxDQUFDLGVBQWUsQ0FBQyxJQUFJLEVBQUUsWUFBWSxDQUFDLE1BQU0sQ0FBQyxDQUFDO2dCQUMzRSx3QkFBd0I7Z0JBQ3hCLENBQUMsQ0FBQyxJQUFJLEtBQUssWUFBWSxDQUFDLE1BQU0sQ0FBQztnQkFDL0IsNEJBQTRCO2dCQUM1QixDQUFDLFlBQVksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUMsRUFBRTtnQkFDaEMsR0FBRyxHQUFHLFFBQVEsQ0FBQyxZQUFZLENBQUMsQ0FBQTthQUM3QjtZQUVELElBQUksR0FBRyxLQUFLLFNBQVMsRUFBRTtnQkFDckIsT0FBTyxHQUFHLENBQUE7YUFDWDtTQUNGO0lBQ0gsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgYXJyIGZyb20gJ0BpbnRlcmFjdGpzL3V0aWxzL2FycidcbmltcG9ydCAqIGFzIGRvbVV0aWxzIGZyb20gJ0BpbnRlcmFjdGpzL3V0aWxzL2RvbVV0aWxzJ1xuaW1wb3J0IGV4dGVuZCBmcm9tICdAaW50ZXJhY3Rqcy91dGlscy9leHRlbmQnXG5pbXBvcnQgKiBhcyBpcyBmcm9tICdAaW50ZXJhY3Rqcy91dGlscy9pcydcbmltcG9ydCBTaWduYWxzIGZyb20gJ0BpbnRlcmFjdGpzL3V0aWxzL1NpZ25hbHMnXG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIEludGVyYWN0YWJsZVNldCB7XG4gIHNpZ25hbHMgPSBuZXcgU2lnbmFscygpXG5cbiAgLy8gYWxsIHNldCBpbnRlcmFjdGFibGVzXG4gIGxpc3Q6IEludGVyYWN0LkludGVyYWN0YWJsZVtdID0gW11cblxuICBzZWxlY3Rvck1hcDoge1xuICAgIFtzZWxlY3Rvcjogc3RyaW5nXTogQXJyYXk8eyBjb250ZXh0OiBEb2N1bWVudCB8IEVsZW1lbnQsIGludGVyYWN0YWJsZTogSW50ZXJhY3QuSW50ZXJhY3RhYmxlIH0+XG4gIH0gPSB7fVxuXG4gIGNvbnN0cnVjdG9yIChwcm90ZWN0ZWQgc2NvcGU6IEludGVyYWN0LlNjb3BlKSB7XG4gICAgdGhpcy5zaWduYWxzLm9uKCd1bnNldCcsICh7IGludGVyYWN0YWJsZSB9KSA9PiB7XG4gICAgICBjb25zdCB7IHRhcmdldCwgX2NvbnRleHQ6IGNvbnRleHQgfSA9IGludGVyYWN0YWJsZVxuICAgICAgY29uc3QgdGFyZ2V0TWFwcGluZ3MgPSBpcy5zdHJpbmcodGFyZ2V0KVxuICAgICAgICA/IHRoaXMuc2VsZWN0b3JNYXBbdGFyZ2V0XVxuICAgICAgICA6IHRhcmdldFt0aGlzLnNjb3BlLmlkXVxuXG4gICAgICBjb25zdCB0YXJnZXRJbmRleCA9IHRhcmdldE1hcHBpbmdzLmZpbmRJbmRleCgobSkgPT4gbS5jb250ZXh0ID09PSBjb250ZXh0KVxuICAgICAgaWYgKHRhcmdldE1hcHBpbmdzW3RhcmdldEluZGV4XSkge1xuICAgICAgICAvLyBEZXN0cm95aW5nIG1hcHBpbmdJbmZvJ3MgY29udGV4dCBhbmQgaW50ZXJhY3RhYmxlXG4gICAgICAgIHRhcmdldE1hcHBpbmdzW3RhcmdldEluZGV4XS5jb250ZXh0ID0gbnVsbFxuICAgICAgICB0YXJnZXRNYXBwaW5nc1t0YXJnZXRJbmRleF0uaW50ZXJhY3RhYmxlID0gbnVsbFxuICAgICAgfVxuICAgICAgdGFyZ2V0TWFwcGluZ3Muc3BsaWNlKHRhcmdldEluZGV4LCAxKVxuICAgIH0pXG4gIH1cblxuICBuZXcgKHRhcmdldDogSW50ZXJhY3QuVGFyZ2V0LCBvcHRpb25zPzogYW55KTogSW50ZXJhY3QuSW50ZXJhY3RhYmxlIHtcbiAgICBvcHRpb25zID0gZXh0ZW5kKG9wdGlvbnMgfHwge30sIHtcbiAgICAgIGFjdGlvbnM6IHRoaXMuc2NvcGUuYWN0aW9ucyxcbiAgICB9KVxuICAgIGNvbnN0IGludGVyYWN0YWJsZSA9IG5ldyB0aGlzLnNjb3BlLkludGVyYWN0YWJsZSh0YXJnZXQsIG9wdGlvbnMsIHRoaXMuc2NvcGUuZG9jdW1lbnQpXG4gICAgY29uc3QgbWFwcGluZ0luZm8gPSB7IGNvbnRleHQ6IGludGVyYWN0YWJsZS5fY29udGV4dCwgaW50ZXJhY3RhYmxlIH1cblxuICAgIHRoaXMuc2NvcGUuYWRkRG9jdW1lbnQoaW50ZXJhY3RhYmxlLl9kb2MpXG4gICAgdGhpcy5saXN0LnB1c2goaW50ZXJhY3RhYmxlKVxuXG4gICAgaWYgKGlzLnN0cmluZyh0YXJnZXQpKSB7XG4gICAgICBpZiAoIXRoaXMuc2VsZWN0b3JNYXBbdGFyZ2V0XSkgeyB0aGlzLnNlbGVjdG9yTWFwW3RhcmdldF0gPSBbXSB9XG4gICAgICB0aGlzLnNlbGVjdG9yTWFwW3RhcmdldF0ucHVzaChtYXBwaW5nSW5mbylcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKCFpbnRlcmFjdGFibGUudGFyZ2V0W3RoaXMuc2NvcGUuaWRdKSB7XG4gICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIHRoaXMuc2NvcGUuaWQsIHtcbiAgICAgICAgICB2YWx1ZTogW10sXG4gICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLFxuICAgICAgICB9KVxuICAgICAgfVxuXG4gICAgICB0YXJnZXRbdGhpcy5zY29wZS5pZF0ucHVzaChtYXBwaW5nSW5mbylcbiAgICB9XG5cbiAgICB0aGlzLnNpZ25hbHMuZmlyZSgnbmV3Jywge1xuICAgICAgdGFyZ2V0LFxuICAgICAgb3B0aW9ucyxcbiAgICAgIGludGVyYWN0YWJsZSxcbiAgICAgIHdpbjogdGhpcy5zY29wZS5fd2luLFxuICAgIH0pXG5cbiAgICByZXR1cm4gaW50ZXJhY3RhYmxlXG4gIH1cblxuICBnZXQgKHRhcmdldDogSW50ZXJhY3QuVGFyZ2V0LCBvcHRpb25zKSB7XG4gICAgY29uc3QgY29udGV4dCA9IChvcHRpb25zICYmIG9wdGlvbnMuY29udGV4dCkgfHwgdGhpcy5zY29wZS5kb2N1bWVudFxuICAgIGNvbnN0IGlzU2VsZWN0b3IgPSBpcy5zdHJpbmcodGFyZ2V0KVxuICAgIGNvbnN0IHRhcmdldE1hcHBpbmdzID0gaXNTZWxlY3RvclxuICAgICAgPyB0aGlzLnNlbGVjdG9yTWFwW3RhcmdldCBhcyBzdHJpbmddXG4gICAgICA6IHRhcmdldFt0aGlzLnNjb3BlLmlkXVxuXG4gICAgaWYgKCF0YXJnZXRNYXBwaW5ncykgeyByZXR1cm4gbnVsbCB9XG5cbiAgICBjb25zdCBmb3VuZCA9IGFyci5maW5kKFxuICAgICAgdGFyZ2V0TWFwcGluZ3MsXG4gICAgICAobSkgPT4gbS5jb250ZXh0ID09PSBjb250ZXh0ICYmXG4gICAgICAgIChpc1NlbGVjdG9yIHx8IG0uaW50ZXJhY3RhYmxlLmluQ29udGV4dCh0YXJnZXQpKSlcblxuICAgIHJldHVybiBmb3VuZCAmJiBmb3VuZC5pbnRlcmFjdGFibGVcbiAgfVxuXG4gIGZvckVhY2hNYXRjaCAobm9kZTogRG9jdW1lbnQgfCBFbGVtZW50LCBjYWxsYmFjazogKGludGVyYWN0YWJsZTogYW55KSA9PiBhbnkpIHtcbiAgICBmb3IgKGNvbnN0IGludGVyYWN0YWJsZSBvZiB0aGlzLmxpc3QpIHtcbiAgICAgIGxldCByZXRcblxuICAgICAgaWYgKChpcy5zdHJpbmcoaW50ZXJhY3RhYmxlLnRhcmdldClcbiAgICAgIC8vIHRhcmdldCBpcyBhIHNlbGVjdG9yIGFuZCB0aGUgZWxlbWVudCBtYXRjaGVzXG4gICAgICAgID8gKGlzLmVsZW1lbnQobm9kZSkgJiYgZG9tVXRpbHMubWF0Y2hlc1NlbGVjdG9yKG5vZGUsIGludGVyYWN0YWJsZS50YXJnZXQpKVxuICAgICAgICAvLyB0YXJnZXQgaXMgdGhlIGVsZW1lbnRcbiAgICAgICAgOiBub2RlID09PSBpbnRlcmFjdGFibGUudGFyZ2V0KSAmJlxuICAgICAgICAvLyB0aGUgZWxlbWVudCBpcyBpbiBjb250ZXh0XG4gICAgICAgIChpbnRlcmFjdGFibGUuaW5Db250ZXh0KG5vZGUpKSkge1xuICAgICAgICByZXQgPSBjYWxsYmFjayhpbnRlcmFjdGFibGUpXG4gICAgICB9XG5cbiAgICAgIGlmIChyZXQgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICByZXR1cm4gcmV0XG4gICAgICB9XG4gICAgfVxuICB9XG59XG4iXX0=