import * as utils from '@interactjs/utils';
function start({ interaction, interactable, element, rect, state, startOffset }) {
    const { options } = state;
    const offsets = [];
    const optionsOrigin = utils.rect.rectToXY(utils.rect.resolveRectLike(options.origin));
    const origin = optionsOrigin || utils.getOriginXY(interactable, element, interaction.prepared.name);
    let snapOffset;
    if (options.offset === 'startCoords') {
        snapOffset = {
            x: interaction.coords.start.page.x - origin.x,
            y: interaction.coords.start.page.y - origin.y,
        };
    }
    else {
        const offsetRect = utils.rect.resolveRectLike(options.offset, interactable, element, [interaction]);
        snapOffset = utils.rect.rectToXY(offsetRect) || { x: 0, y: 0 };
        snapOffset.x += origin.x;
        snapOffset.y += origin.y;
    }
    const relativePoints = options.relativePoints || [];
    if (rect && options.relativePoints && options.relativePoints.length) {
        for (let index = 0; index < relativePoints.length; index++) {
            const relativePoint = relativePoints[index];
            offsets.push({
                index,
                relativePoint,
                x: startOffset.left - (rect.width * relativePoint.x) + snapOffset.x,
                y: startOffset.top - (rect.height * relativePoint.y) + snapOffset.y,
            });
        }
    }
    else {
        offsets.push(utils.extend({
            index: 0,
            relativePoint: null,
        }, snapOffset));
    }
    state.offsets = offsets;
}
function set({ interaction, coords, state }) {
    const { options, offsets } = state;
    const origin = utils.getOriginXY(interaction.interactable, interaction.element, interaction.prepared.name);
    const page = utils.extend({}, coords);
    const targets = [];
    let target;
    let i;
    page.x -= origin.x;
    page.y -= origin.y;
    state.realX = page.x;
    state.realY = page.y;
    let len = options.targets ? options.targets.length : 0;
    for (const offset of offsets) {
        const relativeX = page.x - offset.x;
        const relativeY = page.y - offset.y;
        for (let index = 0; index < options.targets.length; index++) {
            const snapTarget = options.targets[index];
            if (utils.is.func(snapTarget)) {
                target = snapTarget(relativeX, relativeY, interaction, offset, index);
            }
            else {
                target = snapTarget;
            }
            if (!target) {
                continue;
            }
            targets.push({
                x: utils.is.number(target.x) ? (target.x + offset.x) : relativeX,
                y: utils.is.number(target.y) ? (target.y + offset.y) : relativeY,
                range: utils.is.number(target.range) ? target.range : options.range,
            });
        }
    }
    const closest = {
        target: null,
        inRange: false,
        distance: 0,
        range: 0,
        dx: 0,
        dy: 0,
    };
    for (i = 0, len = targets.length; i < len; i++) {
        target = targets[i];
        const range = target.range;
        const dx = target.x - page.x;
        const dy = target.y - page.y;
        const distance = utils.hypot(dx, dy);
        let inRange = distance <= range;
        // Infinite targets count as being out of range
        // compared to non infinite ones that are in range
        if (range === Infinity && closest.inRange && closest.range !== Infinity) {
            inRange = false;
        }
        if (!closest.target || (inRange
            // is the closest target in range?
            ? (closest.inRange && range !== Infinity
                // the pointer is relatively deeper in this target
                ? distance / range < closest.distance / closest.range
                // this target has Infinite range and the closest doesn't
                : (range === Infinity && closest.range !== Infinity) ||
                    // OR this target is closer that the previous closest
                    distance < closest.distance)
            // The other is not in range and the pointer is closer to this target
            : (!closest.inRange && distance < closest.distance))) {
            closest.target = target;
            closest.distance = distance;
            closest.range = range;
            closest.inRange = inRange;
            closest.dx = dx;
            closest.dy = dy;
            state.range = range;
        }
    }
    if (closest.inRange) {
        coords.x = closest.target.x;
        coords.y = closest.target.y;
    }
    state.closest = closest;
}
const snap = {
    start,
    set,
    defaults: {
        enabled: false,
        range: Infinity,
        targets: null,
        offset: null,
        relativePoints: null,
    },
};
export default snap;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG9pbnRlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInBvaW50ZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxLQUFLLEtBQUssTUFBTSxtQkFBbUIsQ0FBQTtBQUUxQyxTQUFTLEtBQUssQ0FBRSxFQUFFLFdBQVcsRUFBRSxZQUFZLEVBQUUsT0FBTyxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUUsV0FBVyxFQUFFO0lBQzlFLE1BQU0sRUFBRSxPQUFPLEVBQUUsR0FBRyxLQUFLLENBQUE7SUFDekIsTUFBTSxPQUFPLEdBQUcsRUFBRSxDQUFBO0lBQ2xCLE1BQU0sYUFBYSxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFBO0lBQ3JGLE1BQU0sTUFBTSxHQUFHLGFBQWEsSUFBSSxLQUFLLENBQUMsV0FBVyxDQUFDLFlBQVksRUFBRSxPQUFPLEVBQUUsV0FBVyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQTtJQUVuRyxJQUFJLFVBQVUsQ0FBQTtJQUVkLElBQUksT0FBTyxDQUFDLE1BQU0sS0FBSyxhQUFhLEVBQUU7UUFDcEMsVUFBVSxHQUFHO1lBQ1gsQ0FBQyxFQUFFLFdBQVcsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQUcsTUFBTSxDQUFDLENBQUM7WUFDN0MsQ0FBQyxFQUFFLFdBQVcsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQUcsTUFBTSxDQUFDLENBQUM7U0FDOUMsQ0FBQTtLQUNGO1NBQ0s7UUFDSixNQUFNLFVBQVUsR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxPQUFPLENBQUMsTUFBTSxFQUFFLFlBQVksRUFBRSxPQUFPLEVBQUUsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFBO1FBRW5HLFVBQVUsR0FBRyxL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LENBQUMsT0FBTyxDQUFDLE9BQU8sSUFBSSxRQUFRLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDLEVBQUU7WUFDdEQsT0FBTyxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUE7WUFDdkIsT0FBTyxDQUFDLFFBQVEsR0FBRyxRQUFRLENBQUE7WUFDM0IsT0FBTyxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUE7WUFDckIsT0FBTyxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUE7WUFDekIsT0FBTyxDQUFDLEVBQUUsR0FBRyxFQUFFLENBQUE7WUFDZixPQUFPLENBQUMsRUFBRSxHQUFHLEVBQUUsQ0FBQTtZQUVmLEtBQUssQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFBO1NBQ3BCO0tBQ0Y7SUFFRCxJQUFJLE9BQU8sQ0FBQyxPQUFPLEVBQUU7UUFDbkIsTUFBTSxDQUFDLENBQUMsR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQTtRQUMzQixNQUFNLENBQUMsQ0FBQyxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFBO0tBQzVCO0lBRUQsS0FBSyxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUE7QUFDekIsQ0FBQztBQUVELE1BQU0sSUFBSSxHQUFHO0lBQ1gsS0FBSztJQUNMLEdBQUc7SUFDSCxRQUFRLEVBQUU7UUFDUixPQUFPLEVBQUUsS0FBSztRQUNkLEtBQUssRUFBSSxRQUFRO1FBQ2pCLE9BQU8sRUFBRSxJQUFJO1FBQ2IsTUFBTSxFQUFFLElBQUk7UUFFWixjQUFjLEVBQUUsSUFBSTtLQUNyQjtDQUNGLENBQUE7QUFFRCxlQUFlLElBQUksQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIHV0aWxzIGZyb20gJ0BpbnRlcmFjdGpzL3V0aWxzJ1xuXG5mdW5jdGlvbiBzdGFydCAoeyBpbnRlcmFjdGlvbiwgaW50ZXJhY3RhYmxlLCBlbGVtZW50LCByZWN0LCBzdGF0ZSwgc3RhcnRPZmZzZXQgfSkge1xuICBjb25zdCB7IG9wdGlvbnMgfSA9IHN0YXRlXG4gIGNvbnN0IG9mZnNldHMgPSBbXVxuICBjb25zdCBvcHRpb25zT3JpZ2luID0gdXRpbHMucmVjdC5yZWN0VG9YWSh1dGlscy5yZWN0LnJlc29sdmVSZWN0TGlrZShvcHRpb25zLm9yaWdpbikpXG4gIGNvbnN0IG9yaWdpbiA9IG9wdGlvbnNPcmlnaW4gfHwgdXRpbHMuZ2V0T3JpZ2luWFkoaW50ZXJhY3RhYmxlLCBlbGVtZW50LCBpbnRlcmFjdGlvbi5wcmVwYXJlZC5uYW1lKVxuXG4gIGxldCBzbmFwT2Zmc2V0XG5cbiAgaWYgKG9wdGlvbnMub2Zmc2V0ID09PSAnc3RhcnRDb29yZHMnKSB7XG4gICAgc25hcE9mZnNldCA9IHtcbiAgICAgIHg6IGludGVyYWN0aW9uLmNvb3Jkcy5zdGFydC5wYWdlLnggLSBvcmlnaW4ueCxcbiAgICAgIHk6IGludGVyYWN0aW9uLmNvb3Jkcy5zdGFydC5wYWdlLnkgLSBvcmlnaW4ueSxcbiAgICB9XG4gIH1cbiAgZWxzZSAge1xuICAgIGNvbnN0IG9mZnNldFJlY3QgPSB1dGlscy5yZWN0LnJlc29sdmVSZWN0TGlrZShvcHRpb25zLm9mZnNldCwgaW50ZXJhY3RhYmxlLCBlbGVtZW50LCBbaW50ZXJhY3Rpb25dKVxuXG4gICAgc25hcE9mZnNldCA9IHV0aWxzLnJlY3QucmVjdFRvWFkob2Zmc2V0UmVjdCkgfHwgeyB4OiAwLCB5OiAwIH1cbiAgICBzbmFwT2Zmc2V0LnggKz0gb3JpZ2luLnhcbiAgICBzbmFwT2Zmc2V0LnkgKz0gb3JpZ2luLnlcbiAgfVxuXG4gIGNvbnN0IHJlbGF0aXZlUG9pbnRzID0gb3B0aW9ucy5yZWxhdGl2ZVBvaW50cyB8fCBbXVxuXG4gIGlmIChyZWN0ICYmIG9wdGlvbnMucmVsYXRpdmVQb2ludHMgJiYgb3B0aW9ucy5yZWxhdGl2ZVBvaW50cy5sZW5ndGgpIHtcbiAgICBmb3IgKGxldCBpbmRleCA9IDA7IGluZGV4IDwgcmVsYXRpdmVQb2ludHMubGVuZ3RoOyBpbmRleCsrKSB7XG4gICAgICBjb25zdCByZWxhdGl2ZVBvaW50ID0gcmVsYXRpdmVQb2ludHNbaW5kZXhdXG5cbiAgICAgIG9mZnNldHMucHVzaCh7XG4gICAgICAgIGluZGV4LFxuICAgICAgICByZWxhdGl2ZVBvaW50LFxuICAgICAgICB4OiBzdGFydE9mZnNldC5sZWZ0IC0gKHJlY3Qud2lkdGggICogcmVsYXRpdmVQb2ludC54KSArIHNuYXBPZmZzZXQueCxcbiAgICAgICAgeTogc3RhcnRPZmZzZXQudG9wICAtIChyZWN0LmhlaWdodCAqIHJlbGF0aXZlUG9pbnQueSkgKyBzbmFwT2Zmc2V0LnksXG4gICAgICB9KVxuICAgIH1cbiAgfVxuICBlbHNlIHtcbiAgICBvZmZzZXRzLnB1c2godXRpbHMuZXh0ZW5kKHtcbiAgICAgIGluZGV4OiAwLFxuICAgICAgcmVsYXRpdmVQb2ludDogbnVsbCxcbiAgICB9LCBzbmFwT2Zmc2V0KSlcbiAgfVxuXG4gIHN0YXRlLm9mZnNldHMgPSBvZmZzZXRzXG59XG5cbmZ1bmN0aW9uIHNldCAoeyBpbnRlcmFjdGlvbiwgY29vcmRzLCBzdGF0ZSB9KSB7XG4gIGNvbnN0IHsgb3B0aW9ucywgb2Zmc2V0cyB9ID0gc3RhdGVcblxuICBjb25zdCBvcmlnaW4gPSB1dGlscy5nZXRPcmlnaW5YWShpbnRlcmFjdGlvbi5pbnRlcmFjdGFibGUsIGludGVyYWN0aW9uLmVsZW1lbnQsIGludGVyYWN0aW9uLnByZXBhcmVkLm5hbWUpXG4gIGNvbnN0IHBhZ2UgPSB1dGlscy5leHRlbmQoe30sIGNvb3JkcylcbiAgY29uc3QgdGFyZ2V0cyA9IFtdXG4gIGxldCB0YXJnZXRcbiAgbGV0IGlcblxuICBwYWdlLnggLT0gb3JpZ2luLnhcbiAgcGFnZS55IC09IG9yaWdpbi55XG5cbiAgc3RhdGUucmVhbFggPSBwYWdlLnhcbiAgc3RhdGUucmVhbFkgPSBwYWdlLnlcblxuICBsZXQgbGVuID0gb3B0aW9ucy50YXJnZXRzID8gb3B0aW9ucy50YXJnZXRzLmxlbmd0aCA6IDBcblxuICBmb3IgKGNvbnN0IG9mZnNldCBvZiBvZmZzZXRzKSB7XG4gICAgY29uc3QgcmVsYXRpdmVYID0gcGFnZS54IC0gb2Zmc2V0LnhcbiAgICBjb25zdCByZWxhdGl2ZVkgPSBwYWdlLnkgLSBvZmZzZXQueVxuXG4gICAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IG9wdGlvbnMudGFyZ2V0cy5sZW5ndGg7IGluZGV4KyspIHtcbiAgICAgIGNvbnN0IHNuYXBUYXJnZXQgPSBvcHRpb25zLnRhcmdldHNbaW5kZXhdXG4gICAgICBpZiAodXRpbHMuaXMuZnVuYyhzbmFwVGFyZ2V0KSkge1xuICAgICAgICB0YXJnZXQgPSBzbmFwVGFyZ2V0KHJlbGF0aXZlWCwgcmVsYXRpdmVZLCBpbnRlcmFjdGlvbiwgb2Zmc2V0LCBpbmRleClcbiAgICAgIH1cbiAgICAgIGVsc2Uge1xuICAgICAgICB0YXJnZXQgPSBzbmFwVGFyZ2V0XG4gICAgICB9XG5cbiAgICAgIGlmICghdGFyZ2V0KSB7IGNvbnRpbnVlIH1cblxuICAgICAgdGFyZ2V0cy5wdXNoKHtcbiAgICAgICAgeDogdXRpbHMuaXMubnVtYmVyKHRhcmdldC54KSA/ICh0YXJnZXQueCArIG9mZnNldC54KSA6IHJlbGF0aXZlWCxcbiAgICAgICAgeTogdXRpbHMuaXMubnVtYmVyKHRhcmdldC55KSA/ICh0YXJnZXQueSArIG9mZnNldC55KSA6IHJlbGF0aXZlWSxcblxuICAgICAgICByYW5nZTogdXRpbHMuaXMubnVtYmVyKHRhcmdldC5yYW5nZSkgPyB0YXJnZXQucmFuZ2UgOiBvcHRpb25zLnJhbmdlLFxuICAgICAgfSlcbiAgICB9XG4gIH1cblxuICBjb25zdCBjbG9zZXN0ID0ge1xuICAgIHRhcmdldDogbnVsbCxcbiAgICBpblJhbmdlOiBmYWxzZSxcbiAgICBkaXN0YW5jZTogMCxcbiAgICByYW5nZTogMCxcbiAgICBkeDogMCxcbiAgICBkeTogMCxcbiAgfVxuXG4gIGZvciAoaSA9IDAsIGxlbiA9IHRhcmdldHMubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHtcbiAgICB0YXJnZXQgPSB0YXJnZXRzW2ldXG5cbiAgICBjb25zdCByYW5nZSA9IHRhcmdldC5yYW5nZVxuICAgIGNvbnN0IGR4ID0gdGFyZ2V0LnggLSBwYWdlLnhcbiAgICBjb25zdCBkeSA9IHRhcmdldC55IC0gcGFnZS55XG4gICAgY29uc3QgZGlzdGFuY2UgPSB1dGlscy5oeXBvdChkeCwgZHkpXG4gICAgbGV0IGluUmFuZ2UgPSBkaXN0YW5jZSA8PSByYW5nZVxuXG4gICAgLy8gSW5maW5pdGUgdGFyZ2V0cyBjb3VudCBhcyBiZWluZyBvdXQgb2YgcmFuZ2VcbiAgICAvLyBjb21wYXJlZCB0byBub24gaW5maW5pdGUgb25lcyB0aGF0IGFyZSBpbiByYW5nZVxuICAgIGlmIChyYW5nZSA9PT0gSW5maW5pdHkgJiYgY2xvc2VzdC5pblJhbmdlICYmIGNsb3Nlc3QucmFuZ2UgIT09IEluZmluaXR5KSB7XG4gICAgICBpblJhbmdlID0gZmFsc2VcbiAgICB9XG5cbiAgICBpZiAoIWNsb3Nlc3QudGFyZ2V0IHx8IChpblJhbmdlXG4gICAgICAvLyBpcyB0aGUgY2xvc2VzdCB0YXJnZXQgaW4gcmFuZ2U/XG4gICAgICA/IChjbG9zZXN0LmluUmFuZ2UgJiYgcmFuZ2UgIT09IEluZmluaXR5XG4gICAgICAgIC8vIHRoZSBwb2ludGVyIGlzIHJlbGF0aXZlbHkgZGVlcGVyIGluIHRoaXMgdGFyZ2V0XG4gICAgICAgID8gZGlzdGFuY2UgLyByYW5nZSA8IGNsb3Nlc3QuZGlzdGFuY2UgLyBjbG9zZXN0LnJhbmdlXG4gICAgICAgIC8vIHRoaXMgdGFyZ2V0IGhhcyBJbmZpbml0ZSByYW5nZSBhbmQgdGhlIGNsb3Nlc3QgZG9lc24ndFxuICAgICAgICA6IChyYW5nZSA9PT0gSW5maW5pdHkgJiYgY2xvc2VzdC5yYW5nZSAhPT0gSW5maW5pdHkpIHx8XG4gICAgICAgICAgLy8gT1IgdGhpcyB0YXJnZXQgaXMgY2xvc2VyIHRoYXQgdGhlIHByZXZpb3VzIGNsb3Nlc3RcbiAgICAgICAgICBkaXN0YW5jZSA8IGNsb3Nlc3QuZGlzdGFuY2UpXG4gICAgICAvLyBUaGUgb3RoZXIgaXMgbm90IGluIHJhbmdlIGFuZCB0aGUgcG9pbnRlciBpcyBjbG9zZXIgdG8gdGhpcyB0YXJnZXRcbiAgICAgIDogKCFjbG9zZXN0LmluUmFuZ2UgJiYgZGlzdGFuY2UgPCBjbG9zZXN0LmRpc3RhbmNlKSkpIHtcbiAgICAgIGNsb3Nlc3QudGFyZ2V0ID0gdGFyZ2V0XG4gICAgICBjbG9zZXN0LmRpc3RhbmNlID0gZGlzdGFuY2VcbiAgICAgIGNsb3Nlc3QucmFuZ2UgPSByYW5nZVxuICAgICAgY2xvc2VzdC5pblJhbmdlID0gaW5SYW5nZVxuICAgICAgY2xvc2VzdC5keCA9IGR4XG4gICAgICBjbG9zZXN0LmR5ID0gZHlcblxuICAgICAgc3RhdGUucmFuZ2UgPSByYW5nZVxuICAgIH1cbiAgfVxuXG4gIGlmIChjbG9zZXN0LmluUmFuZ2UpIHtcbiAgICBjb29yZHMueCA9IGNsb3Nlc3QudGFyZ2V0LnhcbiAgICBjb29yZHMueSA9IGNsb3Nlc3QudGFyZ2V0LnlcbiAgfVxuXG4gIHN0YXRlLmNsb3Nlc3QgPSBjbG9zZXN0XG59XG5cbmNvbnN0IHNuYXAgPSB7XG4gIHN0YXJ0LFxuICBzZXQsXG4gIGRlZmF1bHRzOiB7XG4gICAgZW5hYmxlZDogZmFsc2UsXG4gICAgcmFuZ2UgIDogSW5maW5pdHksXG4gICAgdGFyZ2V0czogbnVsbCxcbiAgICBvZmZzZXQ6IG51bGwsXG5cbiAgICByZWxhdGl2ZVBvaW50czogbnVsbCxcbiAgfSxcbn1cblxuZXhwb3J0IGRlZmF1bHQgc25hcFxuIl19