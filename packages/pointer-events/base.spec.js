import test from '@interactjs/_dev/test/test';
import Eventable from '@interactjs/core/Eventable';
import Interaction from '@interactjs/core/Interaction';
import * as helpers from '@interactjs/core/tests/_helpers';
import pointerUtils from '@interactjs/utils/pointerUtils';
import pointerEvents from './base';
import interactableTargets from './interactableTargets';
test('pointerEvents.types', (t) => {
    t.deepEqual(pointerEvents.types, [
        'down',
        'move',
        'up',
        'cancel',
        'tap',
        'doubletap',
        'hold',
    ], 'pointerEvents.types is as expected');
    t.end();
});
test('pointerEvents.fire', (t) => {
    const scope = helpers.mockScope();
    const eventable = new Eventable(pointerEvents.defaults);
    const type = 'TEST';
    const element = {};
    const eventTarget = {};
    const TEST_PROP = ['TEST_PROP'];
    let firedEvent;
    eventable.on(type, (event) => { firedEvent = event; });
    pointerEvents.fire({
        type,
        eventTarget,
        pointer: {},
        event: {},
        interaction: {},
        targets: [{
                eventable,
                element,
                props: {
                    TEST_PROP,
                },
            }],
    });
    t.ok(firedEvent instanceof pointerEvents.PointerEvent, 'Fired event is an instance of pointerEvents.PointerEvent');
    t.equal(firedEvent.type, type, 'Fired event type is correct');
    t.equal(firedEvent.currentTarget, element, 'Fired event currentTarget is correct');
    t.equal(firedEvent.target, eventTarget, 'Fired event target is correct');
    t.equal(firedEvent.TEST_PROP, TEST_PROP, 'Fired event has props from target.props');
    const tapTime = 500;
    const interaction = Object.assign(scope.interactions.new({}), { tapTime: -1, prevTap: null });
    interaction.updatePointer({}, {}, null);
    const tapEvent = Object.assign(new pointerEvents.PointerEvent('tap', {}, {}, null, interaction), {
        timeStamp: tapTime,
    });
    pointerEvents.fire({
        pointerEvent: tapEvent,
        interaction,
        targets: [{
                eventable,
                element,
            }],
    });
    t.equal(interaction.tapTime, tapTime, 'interaction.tapTime is updated');
    t.equal(interaction.prevTap, tapEvent, 'interaction.prevTap is updated');
    t.end();
});
test('pointerEvents.collectEventTargets', (t) => {
    const type = 'TEST';
    const TEST_PROP = ['TEST_PROP'];
    const target = {
        TEST_PROP,
        eventable: new Eventable(pointerEvents.defaults),
    };
    let collectedTargets;
    function onCollect({ targets }) {
        targets.push(target);
        collectedTargets = targets;
    }
    pointerEvents.signals.on('collect-targets', onCollect);
    pointerEvents.collectEventTargets({
        interaction: new Interaction({ signals: helpers.mockSignals() }),
        pointer: {},
        event: {},
        eventTarget: {},
        type,
    });
    t.deepEqual(collectedTargets, [target]);
    pointerEvents.signals.off('collect-targets', onCollect);
    t.end();
});
test('pointerEvents Interaction update-pointer signal', (t) => {
    const scope = helpers.mockScope();
    pointerEvents.install(scope);
    const interaction = scope.interactions.new({});
    const initialHold = { duration: Infinity, timeout: null };
    const event = {};
    interaction.updatePointer(helpers.newPointer(0), event, null, false);
    t.deepEqual(interaction.pointers.map((p) => p.hold), [initialHold], 'set hold info for move on new pointer');
    interaction.removePointer(helpers.newPointer(0), event);
    interaction.updatePointer(helpers.newPointer(0), event, null, true);
    t.deepEqual(interaction.pointers.map((p) => p.hold), [initialHold]);
    interaction.updatePointer(helpers.newPointer(5), event, null, true);
    t.deepEqual(interaction.pointers.map((p) => p.hold), [initialHold, initialHold]);
    t.end();
});
test('pointerEvents Interaction remove-pointer signal', (t) => {
    const scope = helpers.mockScope();
    pointerEvents.install(scope);
    const interaction = scope.interactions.new({});
    const ids = [0, 1, 2, 3];
    const removals = [
        { id: 0, remain: [1, 2, 3], message: 'first of 4' },
        { id: 2, remain: [1, 3], message: 'middle of 3' },
        { id: 3, remain: [1], message: 'last of 2' },
        { id: 1, remain: [], message: 'final' },
    ];
    for (const id of ids) {
        const index = interaction.updatePointer({ pointerId: id }, {}, null, true);
        // use the ids as the pointerInfo.hold value for this test
        interaction.pointers[index].hold = id;
    }
    for (const removal of removals) {
        interaction.removePointer({ pointerId: removal.id }, null);
        t.deepEqual(interaction.pointers.map((p) => p.hold), removal.remain, `${removal.message} - remaining interaction.holdTimers is correct`);
    }
    t.end();
});
test('pointerEvents down move up tap', (t) => {
    const scope = helpers.mockScope();
    pointerEvents.install(scope);
    interactableTargets.install(scope);
    const interaction = scope.interactions.new({});
    const coords = {
        page: { x: 0, y: 0 },
        client: { x: 0, y: 0 },
        timeStamp: Date.now(),
    };
    const event = Object.assign({ target: scope.document.body }, pointerUtils.coordsToEvent(coords));
    const interactable = scope.interactables.new(event.target);
    const fired = [];
    for (const type of pointerEvents.types) {
        interactable.on(type, (e) => fired.push(e));
    }
    interaction.pointerDown(event, event, event.target);
    interaction.pointerMove(event, event, event.target);
    t.deepEqual(fired.map((e) => e.type), ['down'], 'duplicate move event is not fired');
    interaction.pointerUp(event, event, scope.document.body, event.target);
    t.deepEqual(fired.map((e) => e.type), ['down', 'up', 'tap'], 'tap event is fired after down and up event');
    t.end();
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmFzZS5zcGVjLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiYmFzZS5zcGVjLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sSUFBSSxNQUFNLDRCQUE0QixDQUFBO0FBQzdDLE9BQU8sU0FBUyxNQUFNLDRCQUE0QixDQUFBO0FBQ2xELE9BQU8sV0FBVyxNQUFNLDhCQUE4QixDQUFBO0FBQ3RELE9BQU8sS0FBSyxPQUFPLE1BQU0saUNBQWlDLENBQUE7QUFDMUQsT0FBTyxZQUFZLE1BQU0sZ0NBQWdDLENBQUE7QUFDekQsT0FBTyxhQUFhLE1BQU0sUUFBUSxDQUFBO0FBQ2xDLE9BQU8sbUJBQW1CLE1BQU0sdUJBQXVCLENBQUE7QUFFdkQsSUFBSSxDQUFDLHFCQUFxQixFQUFFLENBQUMsQ0FBQyxFQUFFLEVBQUU7SUFDaEMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxhQUFhLENBQUMsS0FBSyxFQUM3QjtRQUNFLE1BQU07UUFDTixNQUFNO1FBQ04sSUFBSTtRQUNKLFFBQVE7UUFDUixLQUFLO1FBQ0wsV0FBVztRQUNYLE1BQU07S0FDUCxFQUNELG9DQUFvQyxDQUFDLENBQUE7SUFFdkMsQ0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFBO0FBQ1QsQ0FBQyxDQUFDLENBQUE7QUFFRixJQUFJLENBQUMsb0JBQW9CLEVBQUUsQ0FBQyxDQUFDLEVBQUUsRUFBRTtJQUMvQixNQUFNLEtBQUssR0FBbUIsT0FBTyxDQUFDLFNBQVMsRUFBRSxDQUFBO0lBRWpELE1BQU0sU0FBUyxHQUFHLElBQUksU0FBUyxDQUFDLGFBQWEsQ0FBQyxRQUFRLENBQUMsQ0FBQTtJQUN2RCxNQUFNLElBQUksR0FBRyxNQUFNLENBQUE7SUFDbkIsTUFBTSxPQUFPLEdBQUcsRUFBRSxDQUFBO0lBQ2xCLE1BQU0sV0FBVyxHQUFHLEVBQUUsQ0FBQTtJQUN0QixNQUFNLFNBQVMsR0FBRyxDQUFDLFdBQVcsQ0FBQyxDQUFBO0lBQy9CLElBQUksVUFBVSxDQUFBO0lBRWQsU0FBUyxD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RCxXQUFXLENBQUMsV0FBVyxDQUFDLEtBQUssRUFBRSxLQUFLLEVBQUUsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFBO0lBRW5ELENBQUMsQ0FBQyxTQUFTLENBQ1QsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUN4QixDQUFDLE1BQU0sQ0FBQyxFQUNSLG1DQUFtQyxDQUFDLENBQUE7SUFFdEMsV0FBVyxDQUFDLFNBQVMsQ0FBQyxLQUFLLEVBQUUsS0FBSyxFQUFFLEtBQUssQ0FBQyxRQUFRLENBQUMsSUFBSSxFQUFFLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQTtJQUV0RSxDQUFDLENBQUMsU0FBUyxDQUNULEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFDeEIsQ0FBQyxNQUFNLEVBQUUsSUFBSSxFQUFFLEtBQUssQ0FBQyxFQUNyQiw0Q0FBNEMsQ0FBQyxDQUFBO0lBRS9DLENBQUMsQ0FBQyxHQUFHLEVBQUUsQ0FBQTtBQUNULENBQUMsQ0FBQyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHRlc3QgZnJvbSAnQGludGVyYWN0anMvX2Rldi90ZXN0L3Rlc3QnXG5pbXBvcnQgRXZlbnRhYmxlIGZyb20gJ0BpbnRlcmFjdGpzL2NvcmUvRXZlbnRhYmxlJ1xuaW1wb3J0IEludGVyYWN0aW9uIGZyb20gJ0BpbnRlcmFjdGpzL2NvcmUvSW50ZXJhY3Rpb24nXG5pbXBvcnQgKiBhcyBoZWxwZXJzIGZyb20gJ0BpbnRlcmFjdGpzL2NvcmUvdGVzdHMvX2hlbHBlcnMnXG5pbXBvcnQgcG9pbnRlclV0aWxzIGZyb20gJ0BpbnRlcmFjdGpzL3V0aWxzL3BvaW50ZXJVdGlscydcbmltcG9ydCBwb2ludGVyRXZlbnRzIGZyb20gJy4vYmFzZSdcbmltcG9ydCBpbnRlcmFjdGFibGVUYXJnZXRzIGZyb20gJy4vaW50ZXJhY3RhYmxlVGFyZ2V0cydcblxudGVzdCgncG9pbnRlckV2ZW50cy50eXBlcycsICh0KSA9PiB7XG4gIHQuZGVlcEVxdWFsKHBvaW50ZXJFdmVudHMudHlwZXMsXG4gICAgW1xuICAgICAgJ2Rvd24nLFxuICAgICAgJ21vdmUnLFxuICAgICAgJ3VwJyxcbiAgICAgICdjYW5jZWwnLFxuICAgICAgJ3RhcCcsXG4gICAgICAnZG91YmxldGFwJyxcbiAgICAgICdob2xkJyxcbiAgICBdLFxuICAgICdwb2ludGVyRXZlbnRzLnR5cGVzIGlzIGFzIGV4cGVjdGVkJylcblxuICB0LmVuZCgpXG59KVxuXG50ZXN0KCdwb2ludGVyRXZlbnRzLmZpcmUnLCAodCkgPT4ge1xuICBjb25zdCBzY29wZTogSW50ZXJhY3QuU2NvcGUgPSBoZWxwZXJzLm1vY2tTY29wZSgpXG5cbiAgY29uc3QgZXZlbnRhYmxlID0gbmV3IEV2ZW50YWJsZShwb2ludGVyRXZlbnRzLmRlZmF1bHRzKVxuICBjb25zdCB0eXBlID0gJ1RFU1QnXG4gIGNvbnN0IGVsZW1lbnQgPSB7fVxuICBjb25zdCBldmVudFRhcmdldCA9IHt9XG4gIGNvbnN0IFRFU1RfUFJPUCA9IFsnVEVTVF9QUk9QJ11cbiAgbGV0IGZpcmVkRXZlbnRcblxuICBldmVudGFibGUub24odHlwZSwgKGV2ZW50KSA9PiB7IGZpcmVkRXZlbnQgPSBldmVudCB9KVxuXG4gIHBvaW50ZXJFdmVudHMuZmlyZSh7XG4gICAgdHlwZSxcbiAgICBldmVudFRhcmdldCxcbiAgICBwb2ludGVyOiB7fSxcbiAgICBldmVudDoge30sXG4gICAgaW50ZXJhY3Rpb246IHt9LFxuICAgIHRhcmdldHM6IFt7XG4gICAgICBldmVudGFibGUsXG4gICAgICBlbGVtZW50LFxuICAgICAgcHJvcHM6IHtcbiAgICAgICAgVEVTVF9QUk9QLFxuICAgICAgfSxcbiAgICB9XSxcbiAgfSBhcyBhbnkpXG5cbiAgdC5vayhmaXJlZEV2ZW50IGluc3RhbmNlb2YgcG9pbnRlckV2ZW50cy5Qb2ludGVyRXZlbnQsXG4gICAgJ0ZpcmVkIGV2ZW50IGlzIGFuIGluc3RhbmNlIG9mIHBvaW50ZXJFdmVudHMuUG9pbnRlckV2ZW50JylcbiAgdC5lcXVhbChmaXJlZEV2ZW50LnR5cGUsIHR5cGUsXG4gICAgJ0ZpcmVkIGV2ZW50IHR5cGUgaXMgY29ycmVjdCcpXG4gIHQuZXF1YWwoZmlyZWRFdmVudC5jdXJyZW50VGFyZ2V0LCBlbGVtZW50LFxuICAgICdGaXJlZCBldmVudCBjdXJyZW50VGFyZ2V0IGlzIGNvcnJlY3QnKVxuICB0LmVxdWFsKGZpcmVkRXZlbnQudGFyZ2V0LCBldmVudFRhcmdldCxcbiAgICAnRmlyZWQgZXZlbnQgdGFyZ2V0IGlzIGNvcnJlY3QnKVxuICB0LmVxdWFsKGZpcmVkRXZlbnQuVEVTVF9QUk9QLCBURVNUX1BST1AsXG4gICAgJ0ZpcmVkIGV2ZW50IGhhcyBwcm9wcyBmcm9tIHRhcmdldC5wcm9wcycpXG5cbiAgY29uc3QgdGFwVGltZSA9IDUwMFxuICBjb25zdCBpbnRlcmFjdGlvbiA9IE9iamVjdC5hc3NpZ24oXG4gICAgc2NvcGUuaW50ZXJhY3Rpb25zLm5ldyh7fSksXG4gICAgeyB0YXBUaW1lOiAtMSwgcHJldlRhcDogbnVsbCB9KVxuXG4gIGludGVyYWN0aW9uLnVwZGF0ZVBvaW50ZXIoe30gYXMgYW55LCB7fSBhcyBhbnksIG51bGwpXG5cbiAgY29uc3QgdGFwRXZlbnQgPSBPYmplY3QuYXNzaWduKG5ldyBwb2ludGVyRXZlbnRzLlBvaW50ZXJFdmVudCgndGFwJywge30sIHt9LCBudWxsLCBpbnRlcmFjdGlvbiksIHtcbiAgICB0aW1lU3RhbXA6IHRhcFRpbWUsXG4gIH0pXG5cbiAgcG9pbnRlckV2ZW50cy5maXJlKHtcbiAgICBwb2ludGVyRXZlbnQ6IHRhcEV2ZW50LFxuICAgIGludGVyYWN0aW9uLFxuICAgIHRhcmdldHM6IFt7XG4gICAgICBldmVudGFibGUsXG4gICAgICBlbGVtZW50LFxuICAgIH1dLFxuICB9IGFzIGFueSlcblxuICB0LmVxdWFsKGludGVyYWN0aW9uLnRhcFRpbWUsIHRhcFRpbWUsXG4gICAgJ2ludGVyYWN0aW9uLnRhcFRpbWUgaXMgdXBkYXRlZCcpXG4gIHQuZXF1YWwoaW50ZXJhY3Rpb24ucHJldlRhcCwgdGFwRXZlbnQsXG4gICAgJ2ludGVyYWN0aW9uLnByZXZUYXAgaXMgdXBkYXRlZCcpXG5cbiAgdC5lbmQoKVxufSlcblxudGVzdCgncG9pbnRlckV2ZW50cy5jb2xsZWN0RXZlbnRUYXJnZXRzJywgKHQpID0+IHtcbiAgY29uc3QgdHlwZSA9ICdURVNUJ1xuICBjb25zdCBURVNUX1BST1AgPSBbJ1RFU1RfUFJPUCddXG4gIGNvbnN0IHRhcmdldCA9IHtcbiAgICBURVNUX1BST1AsXG4gICAgZXZlbnRhYmxlOiBuZXcgRXZlbnRhYmxlKHBvaW50ZXJFdmVudHMuZGVmYXVsdHMpLFxuICB9XG4gIGxldCBjb2xsZWN0ZWRUYXJnZXRzXG5cbiAgZnVuY3Rpb24gb25Db2xsZWN0ICh7IHRhcmdldHMgfSkge1xuICAgIHRhcmdldHMucHVzaCh0YXJnZXQpXG5cbiAgICBjb2xsZWN0ZWRUYXJnZXRzID0gdGFyZ2V0c1xuICB9XG5cbiAgcG9pbnRlckV2ZW50cy5zaWduYWxzLm9uKCdjb2xsZWN0LXRhcmdldHMnLCBvbkNvbGxlY3QpXG4gIHBvaW50ZXJFdmVudHMuY29sbGVjdEV2ZW50VGFyZ2V0cyh7XG4gICAgaW50ZXJhY3Rpb246IG5ldyBJbnRlcmFjdGlvbih7IHNpZ25hbHM6IGhlbHBlcnMubW9ja1NpZ25hbHMoKSB9IGFzIGFueSksXG4gICAgcG9pbnRlcjoge30sXG4gICAgZXZlbnQ6IHt9LFxuICAgIGV2ZW50VGFyZ2V0OiB7fSxcbiAgICB0eXBlLFxuICB9IGFzIGFueSlcblxuICB0LmRlZXBFcXVhbChjb2xsZWN0ZWRUYXJnZXRzLCBbdGFyZ2V0XSlcblxuICBwb2ludGVyRXZlbnRzLnNpZ25hbHMub2ZmKCdjb2xsZWN0LXRhcmdldHMnLCBvbkNvbGxlY3QpXG5cbiAgdC5lbmQoKVxufSlcblxudGVzdCgncG9pbnRlckV2ZW50cyBJbnRlcmFjdGlvbiB1cGRhdGUtcG9pbnRlciBzaWduYWwnLCAodCkgPT4ge1xuICBjb25zdCBzY29wZTogSW50ZXJhY3QuU2NvcGUgPSBoZWxwZXJzLm1vY2tTY29wZSgpXG5cbiAgcG9pbnRlckV2ZW50cy5pbnN0YWxsKHNjb3BlKVxuXG4gIGNvbnN0IGludGVyYWN0aW9uID0gc2NvcGUuaW50ZXJhY3Rpb25zLm5ldyh7fSlcbiAgY29uc3QgaW5pdGlhbEhvbGQgPSB7IGR1cmF0aW9uOiBJbmZpbml0eSwgdGltZW91dDogbnVsbCB9XG4gIGNvbnN0IGV2ZW50ID0ge30gYXMgSW50ZXJhY3QuUG9pbnRlckV2ZW50VHlwZVxuXG4gIGludGVyYWN0aW9uLnVwZGF0ZVBvaW50ZXIoaGVscGVycy5uZXdQb2ludGVyKDApLCBldmVudCwgbnVsbCwgZmFsc2UpXG4gIHQuZGVlcEVxdWFsKGludGVyYWN0aW9uLnBvaW50ZXJzLm1hcCgocCkgPT4gcC5ob2xkKSwgW2luaXRpYWxIb2xkXSwgJ3NldCBob2xkIGluZm8gZm9yIG1vdmUgb24gbmV3IHBvaW50ZXInKVxuXG4gIGludGVyYWN0aW9uLnJlbW92ZVBvaW50ZXIoaGVscGVycy5uZXdQb2ludGVyKDApLCBldmVudClcblxuICBpbnRlcmFjdGlvbi51cGRhdGVQb2ludGVyKGhlbHBlcnMubmV3UG9pbnRlcigwKSwgZXZlbnQsIG51bGwsIHRydWUpXG4gIHQuZGVlcEVxdWFsKGludGVyYWN0aW9uLnBvaW50ZXJzLm1hcCgocCkgPT4gcC5ob2xkKSwgW2luaXRpYWxIb2xkXSlcblxuICBpbnRlcmFjdGlvbi51cGRhdGVQb2ludGVyKGhlbHBlcnMubmV3UG9pbnRlcig1KSwgZXZlbnQsIG51bGwsIHRydWUpXG4gIHQuZGVlcEVxdWFsKGludGVyYWN0aW9uLnBvaW50ZXJzLm1hcCgocCkgPT4gcC5ob2xkKSwgW2luaXRpYWxIb2xkLCBpbml0aWFsSG9sZF0pXG5cbiAgdC5lbmQoKVxufSlcblxudGVzdCgncG9pbnRlckV2ZW50cyBJbnRlcmFjdGlvbiByZW1vdmUtcG9pbnRlciBzaWduYWwnLCAodCkgPT4ge1xuICBjb25zdCBzY29wZTogSW50ZXJhY3QuU2NvcGUgPSBoZWxwZXJzLm1vY2tTY29wZSgpXG5cbiAgcG9pbnRlckV2ZW50cy5pbnN0YWxsKHNjb3BlKVxuXG4gIGNvbnN0IGludGVyYWN0aW9uID0gc2NvcGUuaW50ZXJhY3Rpb25zLm5ldyh7fSlcblxuICBjb25zdCBpZHMgPSBbMCwgMSwgMiwgM11cbiAgY29uc3QgcmVtb3ZhbHMgPSBbXG4gICAgeyBpZDogMCwgcmVtYWluOiBbMSwgMiwgM10sIG1lc3NhZ2U6ICdmaXJzdCBvZiA0JyAgfSxcbiAgICB7IGlkOiAyLCByZW1haW46IFsxLCAgICAzXSwgbWVzc2FnZTogJ21pZGRsZSBvZiAzJyB9LFxuICAgIHsgaWQ6IDMsIHJlbWFpbjogWzEgICAgICBdLCBtZXNzYWdlOiAnbGFzdCBvZiAyJyAgIH0sXG4gICAgeyBpZDogMSwgcmVtYWluOiBbICAgICAgIF0sIG1lc3NhZ2U6ICdmaW5hbCcgICAgICAgfSxcbiAgXVxuXG4gIGZvciAoY29uc3QgaWQgb2YgaWRzKSB7XG4gICAgY29uc3QgaW5kZXggPSBpbnRlcmFjdGlvbi51cGRhdGVQb2ludGVyKHsgcG9pbnRlcklkOiBpZCB9IGFzIEludGVyYWN0LlBvaW50ZXJUeXBlLCB7fSBhcyBJbnRlcmFjdC5Qb2ludGVyRXZlbnRUeXBlLCBudWxsLCB0cnVlKVxuICAgIC8vIHVzZSB0aGUgaWRzIGFzIHRoZSBwb2ludGVySW5mby5ob2xkIHZhbHVlIGZvciB0aGlzIHRlc3RcbiAgICBpbnRlcmFjdGlvbi5wb2ludGVyc1tpbmRleF0uaG9sZCA9IGlkIGFzIGFueVxuICB9XG5cbiAgZm9yIChjb25zdCByZW1vdmFsIG9mIHJlbW92YWxzKSB7XG4gICAgaW50ZXJhY3Rpb24ucmVtb3ZlUG9pbnRlcih7IHBvaW50ZXJJZDogcmVtb3ZhbC5pZCB9IGFzIGFueSwgbnVsbClcblxuICAgIHQuZGVlcEVxdWFsKGludGVyYWN0aW9uLnBvaW50ZXJzLm1hcCgocCkgPT4gcC5ob2xkIGFzIHVua25vd24gYXMgbnVtYmVyKSwgcmVtb3ZhbC5yZW1haW4sXG4gICAgICBgJHtyZW1vdmFsLm1lc3NhZ2V9IC0gcmVtYWluaW5nIGludGVyYWN0aW9uLmhvbGRUaW1lcnMgaXMgY29ycmVjdGApXG4gIH1cblxuICB0LmVuZCgpXG59KVxuXG50ZXN0KCdwb2ludGVyRXZlbnRzIGRvd24gbW92ZSB1cCB0YXAnLCAodCkgPT4ge1xuICBjb25zdCBzY29wZTogSW50ZXJhY3QuU2NvcGUgPSBoZWxwZXJzLm1vY2tTY29wZSgpXG5cbiAgcG9pbnRlckV2ZW50cy5pbnN0YWxsKHNjb3BlKVxuICBpbnRlcmFjdGFibGVUYXJnZXRzLmluc3RhbGwoc2NvcGUpXG5cbiAgY29uc3QgaW50ZXJhY3Rpb24gPSBzY29wZS5pbnRlcmFjdGlvbnMubmV3KHt9KVxuICBjb25zdCBjb29yZHMgPSB7XG4gICAgcGFnZSAgICAgOiB7IHg6IDAsIHk6IDAgfSxcbiAgICBjbGllbnQgICA6IHsgeDogMCwgeTogMCB9LFxuICAgIHRpbWVTdGFtcDogRGF0ZS5ub3coKSxcbiAgfVxuICBjb25zdCBldmVudCA9IE9iamVjdC5hc3NpZ24oeyB0YXJnZXQ6IHNjb3BlLmRvY3VtZW50LmJvZHkgfSwgcG9pbnRlclV0aWxzLmNvb3Jkc1RvRXZlbnQoY29vcmRzKSlcbiAgY29uc3QgaW50ZXJhY3RhYmxlID0gc2NvcGUuaW50ZXJhY3RhYmxlcy5uZXcoZXZlbnQudGFyZ2V0KVxuICBjb25zdCBmaXJlZDogRXZlbnRbXSA9IFtdXG5cbiAgZm9yIChjb25zdCB0eXBlIG9mIHBvaW50ZXJFdmVudHMudHlwZXMpIHtcbiAgICBpbnRlcmFjdGFibGUub24odHlwZSwgKGUpID0+IGZpcmVkLnB1c2goZSkpXG4gIH1cblxuICBpbnRlcmFjdGlvbi5wb2ludGVyRG93bihldmVudCwgZXZlbnQsIGV2ZW50LnRhcmdldClcbiAgaW50ZXJhY3Rpb24ucG9pbnRlck1vdmUoZXZlbnQsIGV2ZW50LCBldmVudC50YXJnZXQpXG5cbiAgdC5kZWVwRXF1YWwoXG4gICAgZmlyZWQubWFwKChlKSA9PiBlLnR5cGUpLFxuICAgIFsnZG93biddLFxuICAgICdkdXBsaWNhdGUgbW92ZSBldmVudCBpcyBub3QgZmlyZWQnKVxuXG4gIGludGVyYWN0aW9uLnBvaW50ZXJVcChldmVudCwgZXZlbnQsIHNjb3BlLmRvY3VtZW50LmJvZHksIGV2ZW50LnRhcmdldClcblxuICB0LmRlZXBFcXVhbChcbiAgICBmaXJlZC5tYXAoKGUpID0+IGUudHlwZSksXG4gICAgWydkb3duJywgJ3VwJywgJ3RhcCddLFxuICAgICd0YXAgZXZlbnQgaXMgZmlyZWQgYWZ0ZXIgZG93biBhbmQgdXAgZXZlbnQnKVxuXG4gIHQuZW5kKClcbn0pXG4iXX0=