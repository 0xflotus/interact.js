import test from '@interactjs/_dev/test/test';
import * as helpers from '@interactjs/core/tests/_helpers';
import PromisePolyfill from 'promise-polyfill';
import reflow from './';
test('reflow', (t) => {
    const rect = Object.freeze({ top: 100, left: 200, bottom: 300, right: 400 });
    const { scope, interactable, } = helpers.testEnv({ plugins: [reflow], rect });
    Object.assign(scope.actions, { TEST: {}, names: ['TEST'] });
    t.ok(scope.Interactable.prototype.reflow instanceof Function, 'reflow method is added to Interactable.prototype');
    const fired = [];
    interactable.fire = ((iEvent) => { fired.push(iEvent); });
    interactable.target = {};
    interactable.options.TEST = { enabled: true };
    interactable.rectChecker(() => ({ ...rect }));
    // modify move coords
    scope.interactions.signals.on('before-action-move', ({ interaction }) => {
        interaction.coords.cur.page = {
            x: rect.left + 100,
            y: rect.top - 50,
        };
    });
    interactable.reflow({ name: 'TEST' });
    const phases = ['reflow', 'start', 'move', 'end'];
    for (const index in phases) {
        const phase = phases[index];
        t.equal(fired[index].type, `TEST${phase}`, `event #${index} is ${phase}`);
    }
    const interaction = fired[0].interaction;
    t.deepEqual(interaction.coords.start.page, {
        x: rect.left,
        y: rect.top,
    }, 'uses element top left for event coords');
    const reflowMove = fired[2];
    t.deepEqual(reflowMove.delta, { x: 100, y: -50 }, 'move delta is correct with modified interaction coords');
    t.notOk(interaction.pointerIsDown, 'reflow pointer was lifted');
    t.equal(interaction.pointers.length, 0, 'reflow pointer was removed from interaction');
    t.notOk(scope.interactions.list.includes(interaction), 'interaction is removed from list');
    t.end();
});
test('async reflow', async (t) => {
    const scope = helpers.mockScope();
    Object.assign(scope.actions, { TEST: {}, names: ['TEST'] });
    let reflowEvent;
    let promise;
    const interactable = scope.interactables.new(scope.window);
    const rect = Object.freeze({ top: 100, left: 200, bottom: 300, right: 400 });
    interactable.rectChecker(() => ({ ...rect }));
    interactable.fire = ((iEvent) => { reflowEvent = iEvent; });
    interactable.options.TEST = { enabled: true };
    scope.usePlugin(reflow);
    // test with Promise implementation
    scope.window.Promise = PromisePolyfill;
    promise = interactable.reflow({ name: 'TEST' });
    t.ok(promise instanceof scope.window.Promise, 'method returns a Promise if available');
    t.notOk(reflowEvent.interaction.interacting(), 'reflow may end synchronously');
    t.equal(await promise, interactable, 'returned Promise resolves to interactable');
    let stoppedFromTimeout;
    // block the end of the reflow interaction and stop it after a timeout
    scope.interactions.signals.on('before-action-end', ({ interaction }) => {
        setTimeout(() => { interaction.stop(); stoppedFromTimeout = true; }, 0);
        return false;
    });
    stoppedFromTimeout = false;
    promise = interactable.reflow({ name: 'TEST' });
    t.ok(reflowEvent.interaction.interacting() && !stoppedFromTimeout, 'interaction continues if end is blocked');
    await promise;
    t.notOk(reflowEvent.interaction.interacting() && stoppedFromTimeout, 'interaction is stopped after promise is resolved');
    // test without Promise implementation
    stoppedFromTimeout = false;
    scope.window.Promise = undefined;
    promise = interactable.reflow({ name: 'TEST' });
    t.equal(promise, null, 'method returns null if no Proise is avilable');
    t.ok(reflowEvent.interaction.interacting() && !stoppedFromTimeout, 'interaction continues if end is blocked without Promise');
    setTimeout(() => {
        t.notOk(reflowEvent.interaction.interacting() || !stoppedFromTimeout, 'interaction is stopped after timeout without Promised');
    }, 0);
    t.end();
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVmbG93LnNwZWMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJyZWZsb3cuc3BlYy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLElBQUksTUFBTSw0QkFBNEIsQ0FBQTtBQUM3QyxPQUFPLEtBQUssT0FBTyxNQUFNLGlDQUFpQyxDQUFBO0FBQzFELE9BQU8sZUFBZSxNQUFNLGtCQUFrQixDQUFBO0FBQzlDLE9BQU8sTUFBTSxNQUFNLElBQUksQ0FBQTtBQUV2QixJQUFJLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQyxFQUFFLEVBQUU7SUFDbkIsTUFBTSxJQUFJLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLEdBQUcsRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLEtBQUssRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFBO0lBRTVFLE1BQU0sRUFDSixLQUFLLEVBQ0wsWUFBWSxHQUNiLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQyxFQUFFLE9BQU8sRUFBRSxDQUFDLE1BQU0sQ0FBQyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUE7SUFFaEQsTUFBTSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsT0FBTyxFQUFFLEVBQUUsSUFBSSxFQUFFLEVBQUUsRUFBRSxLQUFLLEVBQUUsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUE7SUFFM0QsQ0FBQyxDQUFDLEVBQUUsQ0FDRixLQUFLLENBQUMsWUFBWSxDQUFDLFNBQVMsQ0FBQyxNQUFNLFlBQVksUUFBUSxFQUN2RCxrREFBa0QsQ0FDbkQsQ0FBQTtJQUVELE1BQU0sS0FBSyxHQUFHLEVBQUUsQ0FBQTtJQUVoQixZQUFZLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQyxNQUFNLEVBQUUsRUFBRSxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUEsQ0FBQyxDQUFDLENBQVEsQ0FBQTtJQUM5RCxZQUFZLENBQUMs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R0FBRyxFQUFFLENBQUE7QUFDVCxDQUFDLENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB0ZXN0IGZyb20gJ0BpbnRlcmFjdGpzL19kZXYvdGVzdC90ZXN0J1xuaW1wb3J0ICogYXMgaGVscGVycyBmcm9tICdAaW50ZXJhY3Rqcy9jb3JlL3Rlc3RzL19oZWxwZXJzJ1xuaW1wb3J0IFByb21pc2VQb2x5ZmlsbCBmcm9tICdwcm9taXNlLXBvbHlmaWxsJ1xuaW1wb3J0IHJlZmxvdyBmcm9tICcuLydcblxudGVzdCgncmVmbG93JywgKHQpID0+IHtcbiAgY29uc3QgcmVjdCA9IE9iamVjdC5mcmVlemUoeyB0b3A6IDEwMCwgbGVmdDogMjAwLCBib3R0b206IDMwMCwgcmlnaHQ6IDQwMCB9KVxuXG4gIGNvbnN0IHtcbiAgICBzY29wZSxcbiAgICBpbnRlcmFjdGFibGUsXG4gIH0gPSBoZWxwZXJzLnRlc3RFbnYoeyBwbHVnaW5zOiBbcmVmbG93XSwgcmVjdCB9KVxuXG4gIE9iamVjdC5hc3NpZ24oc2NvcGUuYWN0aW9ucywgeyBURVNUOiB7fSwgbmFtZXM6IFsnVEVTVCddIH0pXG5cbiAgdC5vayhcbiAgICBzY29wZS5JbnRlcmFjdGFibGUucHJvdG90eXBlLnJlZmxvdyBpbnN0YW5jZW9mIEZ1bmN0aW9uLFxuICAgICdyZWZsb3cgbWV0aG9kIGlzIGFkZGVkIHRvIEludGVyYWN0YWJsZS5wcm90b3R5cGUnXG4gIClcblxuICBjb25zdCBmaXJlZCA9IFtdXG5cbiAgaW50ZXJhY3RhYmxlLmZpcmUgPSAoKGlFdmVudCkgPT4geyBmaXJlZC5wdXNoKGlFdmVudCkgfSkgYXMgYW55XG4gIChpbnRlcmFjdGFibGUudGFyZ2V0IGFzIGFueSkgPSB7fVxuICBpbnRlcmFjdGFibGUub3B0aW9ucy5URVNUID0geyBlbmFibGVkOiB0cnVlIH1cbiAgaW50ZXJhY3RhYmxlLnJlY3RDaGVja2VyKCgpID0+ICh7IC4uLnJlY3QgfSkpXG5cbiAgLy8gbW9kaWZ5IG1vdmUgY29vcmRzXG4gIHNjb3BlLmludGVyYWN0aW9ucy5zaWduYWxzLm9uKCdiZWZvcmUtYWN0aW9uLW1vdmUnLCAoeyBpbnRlcmFjdGlvbiB9KSA9PiB7XG4gICAgaW50ZXJhY3Rpb24uY29vcmRzLmN1ci5wYWdlID0ge1xuICAgICAgeDogcmVjdC5sZWZ0ICsgMTAwLFxuICAgICAgeTogcmVjdC50b3AgLSA1MCxcbiAgICB9XG4gIH0pXG5cbiAgaW50ZXJhY3RhYmxlLnJlZmxvdyh7IG5hbWU6ICdURVNUJyB9KVxuXG4gIGNvbnN0IHBoYXNlcyA9IFsncmVmbG93JywgJ3N0YXJ0JywgJ21vdmUnLCAnZW5kJ11cblxuICBmb3IgKGNvbnN0IGluZGV4IGluIHBoYXNlcykge1xuICAgIGNvbnN0IHBoYXNlID0gcGhhc2VzW2luZGV4XVxuICAgIHQuZXF1YWwoZmlyZWRbaW5kZXhdLnR5cGUsIGBURVNUJHtwaGFzZX1gLCBgZXZlbnQgIyR7aW5kZXh9IGlzICR7cGhhc2V9YClcbiAgfVxuXG4gIGNvbnN0IGludGVyYWN0aW9uID0gZmlyZWRbMF0uaW50ZXJhY3Rpb25cblxuICB0LmRlZXBFcXVhbChcbiAgICBpbnRlcmFjdGlvbi5jb29yZHMuc3RhcnQucGFnZSxcbiAgICB7XG4gICAgICB4OiByZWN0LmxlZnQsXG4gICAgICB5OiByZWN0LnRvcCxcbiAgICB9LFxuICAgICd1c2VzIGVsZW1lbnQgdG9wIGxlZnQgZm9yIGV2ZW50IGNvb3JkcydcbiAgKVxuXG4gIGNvbnN0IHJlZmxvd01vdmUgPSBmaXJlZFsyXVxuXG4gIHQuZGVlcEVxdWFsKFxuICAgIHJlZmxvd01vdmUuZGVsdGEsXG4gICAgeyB4OiAxMDAsIHk6IC01MCB9LFxuICAgICdtb3ZlIGRlbHRhIGlzIGNvcnJlY3Qgd2l0aCBtb2RpZmllZCBpbnRlcmFjdGlvbiBjb29yZHMnXG4gIClcblxuICB0Lm5vdE9rKFxuICAgIGludGVyYWN0aW9uLnBvaW50ZXJJc0Rvd24sXG4gICAgJ3JlZmxvdyBwb2ludGVyIHdhcyBsaWZ0ZWQnXG4gIClcblxuICB0LmVxdWFsKFxuICAgIGludGVyYWN0aW9uLnBvaW50ZXJzLmxlbmd0aCxcbiAgICAwLFxuICAgICdyZWZsb3cgcG9pbnRlciB3YXMgcmVtb3ZlZCBmcm9tIGludGVyYWN0aW9uJ1xuICApXG5cbiAgdC5ub3RPayhcbiAgICBzY29wZS5pbnRlcmFjdGlvbnMubGlzdC5pbmNsdWRlcyhpbnRlcmFjdGlvbiksXG4gICAgJ2ludGVyYWN0aW9uIGlzIHJlbW92ZWQgZnJvbSBsaXN0J1xuICApXG5cbiAgdC5lbmQoKVxufSlcblxudGVzdCgnYXN5bmMgcmVmbG93JywgYXN5bmMgKHQpID0+IHtcbiAgY29uc3Qgc2NvcGUgPSBoZWxwZXJzLm1vY2tTY29wZSgpXG5cbiAgT2JqZWN0LmFzc2lnbihzY29wZS5hY3Rpb25zLCB7IFRFU1Q6IHt9LCBuYW1lczogWydURVNUJ10gfSlcblxuICBsZXQgcmVmbG93RXZlbnRcbiAgbGV0IHByb21pc2VcblxuICBjb25zdCBpbnRlcmFjdGFibGUgPSBzY29wZS5pbnRlcmFjdGFibGVzLm5ldyhzY29wZS53aW5kb3cpXG4gIGNvbnN0IHJlY3QgPSBPYmplY3QuZnJlZXplKHsgdG9wOiAxMDAsIGxlZnQ6IDIwMCwgYm90dG9tOiAzMDAsIHJpZ2h0OiA0MDAgfSlcbiAgaW50ZXJhY3RhYmxlLnJlY3RDaGVja2VyKCgpID0+ICh7IC4uLnJlY3QgfSkpXG4gIGludGVyYWN0YWJsZS5maXJlID0gKChpRXZlbnQpID0+IHsgcmVmbG93RXZlbnQgPSBpRXZlbnQgfSkgYXMgYW55XG4gIGludGVyYWN0YWJsZS5vcHRpb25zLlRFU1QgPSB7IGVuYWJsZWQ6IHRydWUgfVxuXG4gIHNjb3BlLnVzZVBsdWdpbihyZWZsb3cpXG5cbiAgLy8gdGVzdCB3aXRoIFByb21pc2UgaW1wbGVtZW50YXRpb25cbiAgc2NvcGUud2luZG93LlByb21pc2UgPSBQcm9taXNlUG9seWZpbGxcblxuICBwcm9taXNlID0gaW50ZXJhY3RhYmxlLnJlZmxvdyh7IG5hbWU6ICdURVNUJyB9KVxuICB0Lm9rKHByb21pc2UgaW5zdGFuY2VvZiBzY29wZS53aW5kb3cuUHJvbWlzZSwgJ21ldGhvZCByZXR1cm5zIGEgUHJvbWlzZSBpZiBhdmFpbGFibGUnKVxuICB0Lm5vdE9rKHJlZmxvd0V2ZW50LmludGVyYWN0aW9uLmludGVyYWN0aW5nKCksICdyZWZsb3cgbWF5IGVuZCBzeW5jaHJvbm91c2x5JylcblxuICB0LmVxdWFsKGF3YWl0IHByb21pc2UsIGludGVyYWN0YWJsZSwgJ3JldHVybmVkIFByb21pc2UgcmVzb2x2ZXMgdG8gaW50ZXJhY3RhYmxlJylcblxuICBsZXQgc3RvcHBlZEZyb21UaW1lb3V0XG4gIC8vIGJsb2NrIHRoZSBlbmQgb2YgdGhlIHJlZmxvdyBpbnRlcmFjdGlvbiBhbmQgc3RvcCBpdCBhZnRlciBhIHRpbWVvdXRcbiAgc2NvcGUuaW50ZXJhY3Rpb25zLnNpZ25hbHMub24oJ2JlZm9yZS1hY3Rpb24tZW5kJywgKHsgaW50ZXJhY3Rpb24gfSkgPT4ge1xuICAgIHNldFRpbWVvdXQoKCkgPT4geyBpbnRlcmFjdGlvbi5zdG9wKCk7IHN0b3BwZWRGcm9tVGltZW91dCA9IHRydWUgfSwgMClcbiAgICByZXR1cm4gZmFsc2VcbiAgfSlcblxuICBzdG9wcGVkRnJvbVRpbWVvdXQgPSBmYWxzZVxuICBwcm9taXNlID0gaW50ZXJhY3RhYmxlLnJlZmxvdyh7IG5hbWU6ICdURVNUJyB9KVxuXG4gIHQub2socmVmbG93RXZlbnQuaW50ZXJhY3Rpb24uaW50ZXJhY3RpbmcoKSAmJiAhc3RvcHBlZEZyb21UaW1lb3V0LCAnaW50ZXJhY3Rpb24gY29udGludWVzIGlmIGVuZCBpcyBibG9ja2VkJylcbiAgYXdhaXQgcHJvbWlzZVxuICB0Lm5vdE9rKHJlZmxvd0V2ZW50LmludGVyYWN0aW9uLmludGVyYWN0aW5nKCkgJiYgc3RvcHBlZEZyb21UaW1lb3V0LCAnaW50ZXJhY3Rpb24gaXMgc3RvcHBlZCBhZnRlciBwcm9taXNlIGlzIHJlc29sdmVkJylcblxuICAvLyB0ZXN0IHdpdGhvdXQgUHJvbWlzZSBpbXBsZW1lbnRhdGlvblxuICBzdG9wcGVkRnJvbVRpbWVvdXQgPSBmYWxzZVxuICBzY29wZS53aW5kb3cuUHJvbWlzZSA9IHVuZGVmaW5lZFxuXG4gIHByb21pc2UgPSBpbnRlcmFjdGFibGUucmVmbG93KHsgbmFtZTogJ1RFU1QnIH0pXG4gIHQuZXF1YWwocHJvbWlzZSwgbnVsbCwgJ21ldGhvZCByZXR1cm5zIG51bGwgaWYgbm8gUHJvaXNlIGlzIGF2aWxhYmxlJylcbiAgdC5vayhyZWZsb3dFdmVudC5pbnRlcmFjdGlvbi5pbnRlcmFjdGluZygpICYmICFzdG9wcGVkRnJvbVRpbWVvdXQsICdpbnRlcmFjdGlvbiBjb250aW51ZXMgaWYgZW5kIGlzIGJsb2NrZWQgd2l0aG91dCBQcm9taXNlJylcblxuICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICB0Lm5vdE9rKHJlZmxvd0V2ZW50LmludGVyYWN0aW9uLmludGVyYWN0aW5nKCkgfHwgIXN0b3BwZWRGcm9tVGltZW91dCwgJ2ludGVyYWN0aW9uIGlzIHN0b3BwZWQgYWZ0ZXIgdGltZW91dCB3aXRob3V0IFByb21pc2VkJylcbiAgfSwgMClcblxuICB0LmVuZCgpXG59KVxuIl19