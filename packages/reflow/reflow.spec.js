import test from '@interactjs/_dev/test/test';
import interactions from '@interactjs/core/interactions';
import * as helpers from '@interactjs/core/tests/_helpers';
import PromisePolyfill from 'promise-polyfill';
import reflow from './';
test('reflow', (t) => {
    const scope = helpers.mockScope();
    interactions.install(scope);
    Object.assign(scope.actions, { test: {}, names: ['test'] });
    reflow.install(scope);
    t.ok(scope.Interactable.prototype.reflow instanceof Function, 'reflow method is added to Interactable.prototype');
    const fired = [];
    const interactable = scope.interactables.new(scope.window);
    const rect = Object.freeze({ top: 100, left: 200, bottom: 300, right: 400 });
    interactable.fire = ((iEvent) => { fired.push(iEvent); });
    interactable.target = {};
    interactable.options.test = {};
    interactable.rectChecker(() => ({ ...rect }));
    // modify move coords
    scope.interactions.signals.on('before-action-move', ({ interaction }) => {
        interaction.coords.cur.page = {
            x: rect.left + 100,
            y: rect.top - 50,
        };
    });
    interactable.reflow({ name: 'test' });
    const phases = ['reflow', 'start', 'move', 'end'];
    for (const index in phases) {
        const phase = phases[index];
        t.equal(fired[index].type, `test${phase}`, `event #${index} is ${phase}`);
    }
    const interaction = fired[0].interaction;
    t.deepEqual(interaction.coords.start.page, {
        x: rect.left,
        y: rect.top,
    }, 'uses element top left for event coords');
    const reflowMove = fired[2];
    t.deepEqual(reflowMove.delta, { x: 100, y: -50 }, 'move delta is correct with modified interaction coords');
    t.notOk(interaction.pointerIsDown, 'reflow pointer was lifted');
    t.equal(interaction.pointers.length, 0, 'reflow pointer was removed from interaction');
    t.notOk(scope.interactions.list.includes(interaction), 'interaction is removed from list');
    t.end();
});
test('async reflow', async (t) => {
    const scope = helpers.mockScope();
    interactions.install(scope);
    Object.assign(scope.actions, { test: {}, names: ['test'] });
    let reflowEvent;
    let promise;
    const interactable = scope.interactables.new(scope.window);
    const rect = Object.freeze({ top: 100, left: 200, bottom: 300, right: 400 });
    interactable.rectChecker(() => ({ ...rect }));
    interactable.fire = ((iEvent) => { reflowEvent = iEvent; });
    reflow.install(scope);
    // test with Promise implementation
    scope.window.Promise = PromisePolyfill;
    promise = interactable.reflow({ name: 'test' });
    t.ok(promise instanceof scope.window.Promise, 'method returns a Promise if available');
    t.notOk(reflowEvent.interaction.interacting(), 'reflow may end synchronously');
    t.equal(await promise, interactable, 'returned Promise resolves to interactable');
    let stoppedFromTimeout;
    // block the end of the reflow interaction and stop it after a timeout
    scope.interactions.signals.on('before-action-end', ({ interaction }) => {
        setTimeout(() => { interaction.stop(); stoppedFromTimeout = true; }, 0);
        return false;
    });
    stoppedFromTimeout = false;
    promise = interactable.reflow({ name: 'test' });
    t.ok(reflowEvent.interaction.interacting() && !stoppedFromTimeout, 'interaction continues if end is blocked');
    await promise;
    t.notOk(reflowEvent.interaction.interacting() && stoppedFromTimeout, 'interaction is stopped after promise is resolved');
    // test without Promise implementation
    stoppedFromTimeout = false;
    scope.window.Promise = undefined;
    promise = interactable.reflow({ name: 'test' });
    t.equal(promise, null, 'method returns null if no Proise is avilable');
    t.ok(reflowEvent.interaction.interacting() && !stoppedFromTimeout, 'interaction continues if end is blocked without Promise');
    setTimeout(() => {
        t.notOk(reflowEvent.interaction.interacting() || !stoppedFromTimeout, 'interaction is stopped after timeout without Promised');
    }, 0);
    t.end();
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVmbG93LnNwZWMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJyZWZsb3cuc3BlYy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLElBQUksTUFBTSw0QkFBNEIsQ0FBQTtBQUM3QyxPQUFPLFlBQVksTUFBTSwrQkFBK0IsQ0FBQTtBQUN4RCxPQUFPLEtBQUssT0FBTyxNQUFNLGlDQUFpQyxDQUFBO0FBQzFELE9BQU8sZUFBZSxNQUFNLGtCQUFrQixDQUFBO0FBQzlDLE9BQU8sTUFBTSxNQUFNLElBQUksQ0FBQTtBQUV2QixJQUFJLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQyxFQUFFLEVBQUU7SUFDbkIsTUFBTSxLQUFLLEdBQUcsT0FBTyxDQUFDLFNBQVMsRUFBRSxDQUFBO0lBRWpDLFlBQVksQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUE7SUFFM0IsTUFBTSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsT0FBTyxFQUFFLEVBQUUsSUFBSSxFQUFFLEVBQUUsRUFBRSxLQUFLLEVBQUUsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUE7SUFFM0QsTUFBTSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQTtJQUVyQixDQUFDLENBQUMsRUFBRSxDQUNGLEtBQUssQ0FBQyxZQUFZLENBQUMsU0FBUyxDQUFDLE1BQU0sWUFBWSxRQUFRLEVBQ3ZELGtEQUFrRCxDQUNuRCxDQUFBO0lBRUQsTUFBTSxLQUFLLEdBQUcsRUFBRSxDQUFBO0lBQ2hCLE1BQU0sWUFBWSxHQUFHLEtBQUssQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQTtJQUMxRCxNQUFNLElBQUksR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsR0FBRyxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsS0FBSyxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUE7SUFFNUUs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LGtCQUFrQixFQUFFLHVEQUF1RCxDQUFDLENBQUE7SUFDaEksQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFBO0lBRUwsQ0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFBO0FBQ1QsQ0FBQyxDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgdGVzdCBmcm9tICdAaW50ZXJhY3Rqcy9fZGV2L3Rlc3QvdGVzdCdcbmltcG9ydCBpbnRlcmFjdGlvbnMgZnJvbSAnQGludGVyYWN0anMvY29yZS9pbnRlcmFjdGlvbnMnXG5pbXBvcnQgKiBhcyBoZWxwZXJzIGZyb20gJ0BpbnRlcmFjdGpzL2NvcmUvdGVzdHMvX2hlbHBlcnMnXG5pbXBvcnQgUHJvbWlzZVBvbHlmaWxsIGZyb20gJ3Byb21pc2UtcG9seWZpbGwnXG5pbXBvcnQgcmVmbG93IGZyb20gJy4vJ1xuXG50ZXN0KCdyZWZsb3cnLCAodCkgPT4ge1xuICBjb25zdCBzY29wZSA9IGhlbHBlcnMubW9ja1Njb3BlKClcblxuICBpbnRlcmFjdGlvbnMuaW5zdGFsbChzY29wZSlcblxuICBPYmplY3QuYXNzaWduKHNjb3BlLmFjdGlvbnMsIHsgdGVzdDoge30sIG5hbWVzOiBbJ3Rlc3QnXSB9KVxuXG4gIHJlZmxvdy5pbnN0YWxsKHNjb3BlKVxuXG4gIHQub2soXG4gICAgc2NvcGUuSW50ZXJhY3RhYmxlLnByb3RvdHlwZS5yZWZsb3cgaW5zdGFuY2VvZiBGdW5jdGlvbixcbiAgICAncmVmbG93IG1ldGhvZCBpcyBhZGRlZCB0byBJbnRlcmFjdGFibGUucHJvdG90eXBlJ1xuICApXG5cbiAgY29uc3QgZmlyZWQgPSBbXVxuICBjb25zdCBpbnRlcmFjdGFibGUgPSBzY29wZS5pbnRlcmFjdGFibGVzLm5ldyhzY29wZS53aW5kb3cpXG4gIGNvbnN0IHJlY3QgPSBPYmplY3QuZnJlZXplKHsgdG9wOiAxMDAsIGxlZnQ6IDIwMCwgYm90dG9tOiAzMDAsIHJpZ2h0OiA0MDAgfSlcblxuICBpbnRlcmFjdGFibGUuZmlyZSA9ICgoaUV2ZW50KSA9PiB7IGZpcmVkLnB1c2goaUV2ZW50KSB9KSBhcyBhbnlcbiAgKGludGVyYWN0YWJsZS50YXJnZXQgYXMgYW55KSA9IHt9XG4gIGludGVyYWN0YWJsZS5vcHRpb25zLnRlc3QgPSB7fVxuICBpbnRlcmFjdGFibGUucmVjdENoZWNrZXIoKCkgPT4gKHsgLi4ucmVjdCB9KSlcblxuICAvLyBtb2RpZnkgbW92ZSBjb29yZHNcbiAgc2NvcGUuaW50ZXJhY3Rpb25zLnNpZ25hbHMub24oJ2JlZm9yZS1hY3Rpb24tbW92ZScsICh7IGludGVyYWN0aW9uIH0pID0+IHtcbiAgICBpbnRlcmFjdGlvbi5jb29yZHMuY3VyLnBhZ2UgPSB7XG4gICAgICB4OiByZWN0LmxlZnQgKyAxMDAsXG4gICAgICB5OiByZWN0LnRvcCAtIDUwLFxuICAgIH1cbiAgfSlcblxuICBpbnRlcmFjdGFibGUucmVmbG93KHsgbmFtZTogJ3Rlc3QnIH0pXG5cbiAgY29uc3QgcGhhc2VzID0gWydyZWZsb3cnLCAnc3RhcnQnLCAnbW92ZScsICdlbmQnXVxuXG4gIGZvciAoY29uc3QgaW5kZXggaW4gcGhhc2VzKSB7XG4gICAgY29uc3QgcGhhc2UgPSBwaGFzZXNbaW5kZXhdXG4gICAgdC5lcXVhbChmaXJlZFtpbmRleF0udHlwZSwgYHRlc3Qke3BoYXNlfWAsIGBldmVudCAjJHtpbmRleH0gaXMgJHtwaGFzZX1gKVxuICB9XG5cbiAgY29uc3QgaW50ZXJhY3Rpb24gPSBmaXJlZFswXS5pbnRlcmFjdGlvblxuXG4gIHQuZGVlcEVxdWFsKFxuICAgIGludGVyYWN0aW9uLmNvb3Jkcy5zdGFydC5wYWdlLFxuICAgIHtcbiAgICAgIHg6IHJlY3QubGVmdCxcbiAgICAgIHk6IHJlY3QudG9wLFxuICAgIH0sXG4gICAgJ3VzZXMgZWxlbWVudCB0b3AgbGVmdCBmb3IgZXZlbnQgY29vcmRzJ1xuICApXG5cbiAgY29uc3QgcmVmbG93TW92ZSA9IGZpcmVkWzJdXG5cbiAgdC5kZWVwRXF1YWwoXG4gICAgcmVmbG93TW92ZS5kZWx0YSxcbiAgICB7IHg6IDEwMCwgeTogLTUwIH0sXG4gICAgJ21vdmUgZGVsdGEgaXMgY29ycmVjdCB3aXRoIG1vZGlmaWVkIGludGVyYWN0aW9uIGNvb3JkcydcbiAgKVxuXG4gIHQubm90T2soXG4gICAgaW50ZXJhY3Rpb24ucG9pbnRlcklzRG93bixcbiAgICAncmVmbG93IHBvaW50ZXIgd2FzIGxpZnRlZCdcbiAgKVxuXG4gIHQuZXF1YWwoXG4gICAgaW50ZXJhY3Rpb24ucG9pbnRlcnMubGVuZ3RoLFxuICAgIDAsXG4gICAgJ3JlZmxvdyBwb2ludGVyIHdhcyByZW1vdmVkIGZyb20gaW50ZXJhY3Rpb24nXG4gIClcblxuICB0Lm5vdE9rKFxuICAgIHNjb3BlLmludGVyYWN0aW9ucy5saXN0LmluY2x1ZGVzKGludGVyYWN0aW9uKSxcbiAgICAnaW50ZXJhY3Rpb24gaXMgcmVtb3ZlZCBmcm9tIGxpc3QnXG4gIClcblxuICB0LmVuZCgpXG59KVxuXG50ZXN0KCdhc3luYyByZWZsb3cnLCBhc3luYyAodCkgPT4ge1xuICBjb25zdCBzY29wZSA9IGhlbHBlcnMubW9ja1Njb3BlKClcblxuICBpbnRlcmFjdGlvbnMuaW5zdGFsbChzY29wZSlcblxuICBPYmplY3QuYXNzaWduKHNjb3BlLmFjdGlvbnMsIHsgdGVzdDoge30sIG5hbWVzOiBbJ3Rlc3QnXSB9KVxuXG4gIGxldCByZWZsb3dFdmVudFxuICBsZXQgcHJvbWlzZVxuXG4gIGNvbnN0IGludGVyYWN0YWJsZSA9IHNjb3BlLmludGVyYWN0YWJsZXMubmV3KHNjb3BlLndpbmRvdylcbiAgY29uc3QgcmVjdCA9IE9iamVjdC5mcmVlemUoeyB0b3A6IDEwMCwgbGVmdDogMjAwLCBib3R0b206IDMwMCwgcmlnaHQ6IDQwMCB9KVxuICBpbnRlcmFjdGFibGUucmVjdENoZWNrZXIoKCkgPT4gKHsgLi4ucmVjdCB9KSlcbiAgaW50ZXJhY3RhYmxlLmZpcmUgPSAoKGlFdmVudCkgPT4geyByZWZsb3dFdmVudCA9IGlFdmVudCB9KSBhcyBhbnlcblxuICByZWZsb3cuaW5zdGFsbChzY29wZSlcblxuICAvLyB0ZXN0IHdpdGggUHJvbWlzZSBpbXBsZW1lbnRhdGlvblxuICBzY29wZS53aW5kb3cuUHJvbWlzZSA9IFByb21pc2VQb2x5ZmlsbFxuXG4gIHByb21pc2UgPSBpbnRlcmFjdGFibGUucmVmbG93KHsgbmFtZTogJ3Rlc3QnIH0pXG4gIHQub2socHJvbWlzZSBpbnN0YW5jZW9mIHNjb3BlLndpbmRvdy5Qcm9taXNlLCAnbWV0aG9kIHJldHVybnMgYSBQcm9taXNlIGlmIGF2YWlsYWJsZScpXG4gIHQubm90T2socmVmbG93RXZlbnQuaW50ZXJhY3Rpb24uaW50ZXJhY3RpbmcoKSwgJ3JlZmxvdyBtYXkgZW5kIHN5bmNocm9ub3VzbHknKVxuXG4gIHQuZXF1YWwoYXdhaXQgcHJvbWlzZSwgaW50ZXJhY3RhYmxlLCAncmV0dXJuZWQgUHJvbWlzZSByZXNvbHZlcyB0byBpbnRlcmFjdGFibGUnKVxuXG4gIGxldCBzdG9wcGVkRnJvbVRpbWVvdXRcbiAgLy8gYmxvY2sgdGhlIGVuZCBvZiB0aGUgcmVmbG93IGludGVyYWN0aW9uIGFuZCBzdG9wIGl0IGFmdGVyIGEgdGltZW91dFxuICBzY29wZS5pbnRlcmFjdGlvbnMuc2lnbmFscy5vbignYmVmb3JlLWFjdGlvbi1lbmQnLCAoeyBpbnRlcmFjdGlvbiB9KSA9PiB7XG4gICAgc2V0VGltZW91dCgoKSA9PiB7IGludGVyYWN0aW9uLnN0b3AoKTsgc3RvcHBlZEZyb21UaW1lb3V0ID0gdHJ1ZSB9LCAwKVxuICAgIHJldHVybiBmYWxzZVxuICB9KVxuXG4gIHN0b3BwZWRGcm9tVGltZW91dCA9IGZhbHNlXG4gIHByb21pc2UgPSBpbnRlcmFjdGFibGUucmVmbG93KHsgbmFtZTogJ3Rlc3QnIH0pXG5cbiAgdC5vayhyZWZsb3dFdmVudC5pbnRlcmFjdGlvbi5pbnRlcmFjdGluZygpICYmICFzdG9wcGVkRnJvbVRpbWVvdXQsICdpbnRlcmFjdGlvbiBjb250aW51ZXMgaWYgZW5kIGlzIGJsb2NrZWQnKVxuICBhd2FpdCBwcm9taXNlXG4gIHQubm90T2socmVmbG93RXZlbnQuaW50ZXJhY3Rpb24uaW50ZXJhY3RpbmcoKSAmJiBzdG9wcGVkRnJvbVRpbWVvdXQsICdpbnRlcmFjdGlvbiBpcyBzdG9wcGVkIGFmdGVyIHByb21pc2UgaXMgcmVzb2x2ZWQnKVxuXG4gIC8vIHRlc3Qgd2l0aG91dCBQcm9taXNlIGltcGxlbWVudGF0aW9uXG4gIHN0b3BwZWRGcm9tVGltZW91dCA9IGZhbHNlXG4gIHNjb3BlLndpbmRvdy5Qcm9taXNlID0gdW5kZWZpbmVkXG5cbiAgcHJvbWlzZSA9IGludGVyYWN0YWJsZS5yZWZsb3coeyBuYW1lOiAndGVzdCcgfSlcbiAgdC5lcXVhbChwcm9taXNlLCBudWxsLCAnbWV0aG9kIHJldHVybnMgbnVsbCBpZiBubyBQcm9pc2UgaXMgYXZpbGFibGUnKVxuICB0Lm9rKHJlZmxvd0V2ZW50LmludGVyYWN0aW9uLmludGVyYWN0aW5nKCkgJiYgIXN0b3BwZWRGcm9tVGltZW91dCwgJ2ludGVyYWN0aW9uIGNvbnRpbnVlcyBpZiBlbmQgaXMgYmxvY2tlZCB3aXRob3V0IFByb21pc2UnKVxuXG4gIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgIHQubm90T2socmVmbG93RXZlbnQuaW50ZXJhY3Rpb24uaW50ZXJhY3RpbmcoKSB8fCAhc3RvcHBlZEZyb21UaW1lb3V0LCAnaW50ZXJhY3Rpb24gaXMgc3RvcHBlZCBhZnRlciB0aW1lb3V0IHdpdGhvdXQgUHJvbWlzZWQnKVxuICB9LCAwKVxuXG4gIHQuZW5kKClcbn0pXG4iXX0=